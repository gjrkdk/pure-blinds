---
milestone: v1.5
audited: 2026-02-27
status: gaps_found
scores:
  requirements: 11/15
  phases: 3/3
  integration: 9/12
  flows: 2/4
gaps:
  requirements:
    - id: "ECOM-03"
      status: "unsatisfied"
      phase: "Phase 24"
      claimed_by_plans: ["24-02-PLAN.md"]
      completed_by_plans: ["24-02-SUMMARY.md"]
      verification_status: "passed (stale — function disabled post-verification)"
      evidence: "trackBeginCheckout() in src/lib/analytics/index.ts lines 65-67 is a no-op — empty function body with comment 'Disabled — see TODO above'. Commit 530fe83 disabled it after UAT confirmed GA4 does not dispatch the event before Shopify redirect fires when analytics_storage is denied."
    - id: "CONS-01"
      status: "partial"
      phase: "Phase 25"
      claimed_by_plans: ["25-01-PLAN.md", "25-02-PLAN.md"]
      completed_by_plans: ["25-01-SUMMARY.md", "25-02-SUMMARY.md"]
      verification_status: "passed (stale — banner changed post-verification)"
      evidence: "Commit 1fcc152 ('settings cookies') changed main banner from 'Weiger alles' to 'Voorkeuren'. 'Weiger alles' now only appears in the preferences modal (two clicks). Requirement specifies both buttons on the banner."
    - id: "CONS-02"
      status: "partial"
      phase: "Phase 25"
      claimed_by_plans: ["25-01-PLAN.md"]
      completed_by_plans: ["25-01-SUMMARY.md"]
      verification_status: "human_needed (stale — banner changed post-verification)"
      evidence: "Main banner now shows 'Accepteer alles' + 'Voorkeuren' — not the accept/reject pair. equalWeightButtons: true applies to both modals but the main banner buttons are accept/open-settings, not accept/reject. The equal-prominence requirement applies to accept vs reject."
    - id: "GA4-02"
      status: "partial"
      phase: "Phase 23"
      claimed_by_plans: ["23-01-PLAN.md"]
      completed_by_plans: ["23-01-SUMMARY.md"]
      verification_status: "passed (implementation correct but functionally dependent on consent)"
      evidence: "Cross-domain linker config is wired (gtag('set', 'linker', ...)), but decorateWithGlLinker() requires _ga cookie and glBridge which only exist after analytics_storage: 'granted'. accept_incoming: true is absent from linker config. UAT confirmed no _gl decoration on Shopify URL."
  integration:
    - from: "Phase 24"
      to: "Phase 23"
      issue: "decorateWithGlLinker() structurally dependent on consent having been granted — _ga cookie and glBridge unavailable when analytics_storage is denied"
      affected_requirements: ["GA4-02", "ECOM-04"]
    - from: "Phase 24"
      to: "Phase 25"
      issue: "begin_checkout event depends on analytics_storage being granted before checkout click — but consent may not have been given"
      affected_requirements: ["ECOM-03"]
  flows:
    - flow: "First Visit — Full Funnel"
      breaks_at: "begin_checkout (no-op function)"
      affected_requirements: ["ECOM-03"]
    - flow: "Cross-Domain Session Continuity"
      breaks_at: "_gl linker decoration (requires consent + _ga cookie)"
      affected_requirements: ["GA4-02"]
tech_debt:
  - phase: 24-e-commerce-events
    items:
      - "trackBeginCheckout disabled — empty function body with TODO comment (commit 530fe83)"
      - "PurchaseTracker moved from /bevestiging to root layout (commit 250fff3) — VERIFICATION.md not updated to reflect architectural change"
      - "sessionStorage purchase snapshot cross-origin survival unverified by UAT (tester likely checked wrong origin)"
  - phase: 25-cookie-consent-banner
    items:
      - "Commit 1fcc152 changed banner UX post-verification — VERIFICATION.md and SUMMARY.md reflect pre-change state"
  - phase: 23-ga4-foundation
    items:
      - "accept_incoming: true absent from cross-domain linker config — return from Shopify may not auto-decode _gl parameter"
---

# Milestone v1.5 Audit: Analytics & Privacy

**Audited:** 2026-02-27
**Status:** gaps_found
**Scores:** Requirements 11/15 | Phases 3/3 | Integration 9/12 | Flows 2/4

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration | Final Status |
|--------|----------------|---------------------|-----------------|-------------|--------------|
| GA4-01 | SATISFIED | listed (23-01) | [x] | WIRED | **satisfied** |
| GA4-02 | SATISFIED | listed (23-01) | [x] | PARTIAL | **partial** |
| GA4-03 | SATISFIED | listed (23-01) | [x] | WIRED | **satisfied** |
| ECOM-01 | SATISFIED | listed (24-01) | [x] | WIRED | **satisfied** |
| ECOM-02 | SATISFIED | listed (24-01) | [x] | WIRED | **satisfied** |
| ECOM-03 | SATISFIED | listed (24-02) | [x] | UNWIRED (no-op) | **unsatisfied** |
| ECOM-04 | SATISFIED | listed (24-02) | [x] | PARTIAL | **partial** |
| ECOM-05 | SATISFIED | listed (24-02) | [x] | WIRED | **satisfied** |
| ECOM-06 | SATISFIED | listed (24-02) | [x] | WIRED | **satisfied** |
| CONS-01 | SATISFIED | listed (25-01, 25-02) | [x] | PARTIAL | **partial** |
| CONS-02 | NEEDS HUMAN | listed (25-01) | [x] | PARTIAL | **partial** |
| CONS-03 | NEEDS HUMAN | listed (25-01) | [x] | WIRED | **satisfied** |
| CONS-04 | SATISFIED | listed (25-01) | [x] | WIRED | **satisfied** |
| CONS-05 | NEEDS HUMAN | listed (25-01) | [x] | WIRED | **satisfied** |
| CONS-06 | SATISFIED | listed (25-01) | [x] | WIRED | **satisfied** |

**Satisfied:** 11/15 | **Partial:** 3/15 | **Unsatisfied:** 1/15 | **Orphaned:** 0

## Gap Details

### 1. ECOM-03: begin_checkout event (UNSATISFIED)

**Requirement:** `begin_checkout` event fires on checkout button click before Shopify redirect

**Current state:** `trackBeginCheckout()` in `src/lib/analytics/index.ts` lines 65-67 is an empty function body. The call site in `cart-summary.tsx` line 77 exists but fires nothing.

**Root cause:** Commit `530fe83` disabled the function after UAT confirmed GA4 does not dispatch the collect request before the Shopify redirect fires when `analytics_storage` is denied. Even `navigator.sendBeacon` fallback requires consent to have been granted first.

**Impact:** Medium — GA4 funnel will show a gap between `add_to_cart` and `purchase` events, making funnel analysis incomplete. The actual checkout flow is not affected.

### 2. CONS-01: "Weiger alles" not on main banner (PARTIAL)

**Requirement:** Dutch-language cookie consent banner with "Accepteer alles" and "Weiger alles" buttons

**Current state:** Commit `1fcc152` changed the main banner's second button from "Weiger alles" to "Voorkeuren" (opens preferences modal). The "Weiger alles" button now only appears inside the preferences modal — requiring two clicks to reject.

**Impact:** GDPR compliance risk — Dutch DPA (Autoriteit Persoonsgegevens) guidelines require reject to be equally accessible. Two-click reject vs one-click accept may constitute a dark pattern.

### 3. CONS-02: Button prominence mismatch (PARTIAL)

**Requirement:** Accept and Reject buttons have equal visual prominence (no dark patterns)

**Current state:** The main banner shows "Accepteer alles" (primary/filled) + "Voorkeuren" (secondary) — these are not the accept/reject pair. The `equalWeightButtons: true` config applies but the buttons compared are not accept vs reject.

**Impact:** Related to CONS-01 — the requirement's intent (no dark pattern between accept/reject) is not met when reject is in a sub-modal.

### 4. GA4-02: Cross-domain tracking (PARTIAL)

**Requirement:** Cross-domain tracking configured between pure-blinds.nl and Shopify checkout domain

**Current state:** The linker config exists (`gtag('set', 'linker', { domains: [...] })`), but:
- `decorateWithGlLinker()` is inert without `_ga` cookie (requires consent)
- `accept_incoming: true` is absent from the linker config
- UAT confirmed no `_gl` parameter on Shopify URL

**Impact:** GA4 sessions will break across the Shopify checkout redirect. Attribution will show (direct)/(none) on the purchase event.

### 5. ECOM-04: Purchase event data path (PARTIAL)

**Requirement:** `purchase` event fires on /bevestiging with transaction_id and complete items array

**Current state:** `PurchaseTracker` was moved from `/bevestiging/page.tsx` to root layout (commit `250fff3`). The move was architecturally sound (purchase fires on any return page), but sessionStorage snapshot survival through cross-origin Shopify redirect is unverified. The VERIFICATION report is stale and reflects the pre-move state.

**Impact:** If sessionStorage does not survive the cross-origin round-trip in all browsers, the purchase event will never fire.

## Phase Verification Summary

| Phase | VERIFICATION Status | Score | Issues |
|-------|-------------------|-------|--------|
| 23 — GA4 Foundation | human_needed | 5/5 automated | 3 items need runtime browser verification |
| 24 — E-Commerce Events | passed (stale) | 8/8 | VERIFICATION does not reflect begin_checkout disabling or PurchaseTracker move |
| 25 — Cookie Consent Banner | human_needed (stale) | 7/7 automated | VERIFICATION does not reflect commit 1fcc152 banner changes |

## Integration Wiring

| Export | Source | Consumer | Status |
|--------|--------|----------|--------|
| sendGtagEvent | gtag.ts | index.ts (all events) | WIRED |
| GA_MEASUREMENT_ID | gtag.ts → index.ts | layout.tsx | WIRED |
| trackPageView | index.ts | analytics-provider.tsx | WIRED |
| trackViewItem | index.ts | dimension-configurator.tsx | WIRED |
| trackAddToCart | index.ts | dimension-configurator.tsx | WIRED |
| trackBeginCheckout | index.ts | cart-summary.tsx | CALL EXISTS, BODY EMPTY |
| trackPurchase | index.ts | purchase-tracker.tsx | WIRED |
| AnalyticsProvider | analytics-provider.tsx | layout.tsx | WIRED |
| PurchaseTracker | purchase-tracker.tsx | layout.tsx (moved from bevestiging) | WIRED |
| CookieConsentBanner | cookie-consent-banner.tsx | layout.tsx | WIRED |
| window.gtag consent update | cookie-consent-banner.tsx | Phase 23 Script 1 | WIRED |

## E2E Flow Analysis

| Flow | Status | Break Point |
|------|--------|-------------|
| First Visit — Full Funnel (Accept → Track → Purchase) | BROKEN | begin_checkout is a no-op |
| Reject Flow — No Consent | COMPLETE | Functionally works but requires 2 clicks |
| Return Visit — Consent Restored | COMPLETE | onConsent hook re-fires, banner stays hidden |
| Cross-Domain Session Continuity | BROKEN | No _gl decoration without consent |

## Tech Debt Summary

**Total: 5 items across 3 phases**

**Phase 24: E-Commerce Events**
- `trackBeginCheckout` disabled — empty function body
- PurchaseTracker architectural change not reflected in VERIFICATION.md
- sessionStorage cross-origin survival unverified

**Phase 25: Cookie Consent Banner**
- Commit `1fcc152` changed banner UX post-verification — docs are stale

**Phase 23: GA4 Foundation**
- `accept_incoming: true` absent from cross-domain linker config

---

_Audited: 2026-02-27_
_Auditor: Claude (gsd-audit-milestone)_
