---
phase: 22-checkout-order-tracking
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/shopify/draft-order.ts
autonomous: true
requirements: [TRACK-01]

must_haves:
  truths:
    - "Draft Orders containing at least one sample line item carry the 'kleurstaal' tag"
    - "Draft Orders with only regular items do NOT carry the 'kleurstaal' tag"
    - "Sample items are identified by type === 'sample' in cart items"
  artifacts:
    - path: "src/lib/shopify/draft-order.ts"
      provides: "Draft Order creation with conditional kleurstaal tagging"
      contains: "kleurstaal"
  key_links:
    - from: "src/lib/shopify/draft-order.ts"
      to: "Shopify GraphQL draftOrderCreate mutation"
      via: "tags field in DraftOrderInput"
      pattern: "tags.*kleurstaal"
---

<objective>
Add the `kleurstaal` tag to Shopify Draft Orders that contain at least one color sample item, enabling operations to identify and filter sample orders in Shopify admin.

Purpose: Operations team needs to quickly identify orders that include color samples for separate handling (different packaging, different fulfillment flow).

Output: Updated Draft Order creation that conditionally includes the `kleurstaal` tag based on cart contents.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/shopify/draft-order.ts
@src/lib/cart/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add conditional kleurstaal tag to Draft Order creation</name>
  <files>
    src/lib/shopify/draft-order.ts
  </files>
  <action>
    **Per locked decisions:**
    - Apply `kleurstaal` tag whenever at least one sample is in the order (not only all-sample orders)
    - Tag only — no additional labels or prefixes on sample line items
    - Sample identification: `item.type === "sample"` (confirmed from codebase — CartItem.type field)

    **In `createDraftOrder` function** (`src/lib/shopify/draft-order.ts`):

    1. Before the `client.request()` call, detect if any item is a sample:
       ```typescript
       const hasSamples = items.some(item => item.type === "sample");
       ```

    2. In the `input` object passed to the GraphQL mutation variables, add the `tags` field conditionally:
       ```typescript
       input: {
         lineItems: items.map(item => { ... }),
         ...(hasSamples && { tags: ["kleurstaal"] }),
       }
       ```

    The Shopify `DraftOrderInput` GraphQL type accepts a `tags` field as `[String!]`. Tags appear on the Draft Order in Shopify admin as comma-separated labels. No changes to the GraphQL mutation string are needed — the mutation already accepts the full `DraftOrderInput` which includes `tags`.

    **Do NOT** modify the line item mapping, custom attributes, or any other part of the mutation. This is a single conditional field addition.
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors. Verify by reading the updated file that:
    1. `hasSamples` check exists before the API call
    2. `tags: ["kleurstaal"]` is conditionally spread into the input object
    3. No other changes to existing line item logic
  </verify>
  <done>
    Draft Orders with at least one sample item include `kleurstaal` tag. Orders with only regular items have no tags. Existing line item structure is unchanged.
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. The `hasSamples` detection uses `item.type === "sample"` (matching CartItem type definition)
3. The `tags` field is conditionally included in DraftOrderInput only when samples are present
4. No regression in existing Draft Order creation logic
</verification>

<success_criteria>
- Draft Orders with sample items carry the `kleurstaal` tag in Shopify admin
- Draft Orders without samples have no extra tags
- Build passes cleanly
- Existing checkout flow is unaffected
</success_criteria>

<output>
After completion, create `.planning/phases/22-checkout-order-tracking/22-02-SUMMARY.md`
</output>
