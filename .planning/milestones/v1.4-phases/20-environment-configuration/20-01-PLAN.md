---
phase: 20-environment-configuration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/env.ts
  - src/lib/product/types.ts
  - src/lib/product/catalog.ts
  - src/lib/shopify/draft-order.ts
  - data/products.json
  - .env.example
  - .env.prod
  - .github/workflows/ci.yml
autonomous: true
requirements: [ENV-01, ENV-02]

must_haves:
  truths:
    - "Adding a product to cart in dev uses the Shopify product/variant ID from environment variables, not from products.json"
    - "Deploying to production with different env vars causes Draft Orders to reference production Shopify IDs without code changes"
    - "products.json contains zero Shopify product or variant ID values"
    - "App fails at build time if SHOPIFY_PRODUCT_MAP env var is missing or malformed"
    - ".env.example documents the SHOPIFY_PRODUCT_MAP env var with placeholder GID values"
  artifacts:
    - path: "src/lib/env.ts"
      provides: "SHOPIFY_PRODUCT_MAP Zod validation with JSON parsing"
      contains: "SHOPIFY_PRODUCT_MAP"
    - path: "src/lib/product/catalog.ts"
      provides: "getShopifyIds function resolving IDs from env"
      contains: "getShopifyIds"
    - path: "data/products.json"
      provides: "Product metadata without Shopify IDs"
    - path: ".env.example"
      provides: "Documented SHOPIFY_PRODUCT_MAP placeholder"
      contains: "SHOPIFY_PRODUCT_MAP"
  key_links:
    - from: "src/lib/shopify/draft-order.ts"
      to: "src/lib/product/catalog.ts"
      via: "getShopifyIds(productId) call"
      pattern: "getShopifyIds"
    - from: "src/lib/product/catalog.ts"
      to: "src/lib/env.ts"
      via: "env.SHOPIFY_PRODUCT_MAP lookup"
      pattern: "SHOPIFY_PRODUCT_MAP"
---

<objective>
Extract hardcoded Shopify product/variant IDs from `data/products.json` into a single JSON-encoded environment variable `SHOPIFY_PRODUCT_MAP`, enabling separate dev and production Shopify stores without code changes.

Purpose: Products.json currently hardcodes Shopify GIDs that differ between dev and prod stores. This makes it impossible to deploy the same code to production without manually editing the JSON. A single JSON env var scales better than 2N individual env vars as the catalog grows.

Output: Environment-driven Shopify ID resolution with build-time Zod validation.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

@src/lib/env.ts
@src/lib/product/types.ts
@src/lib/product/catalog.ts
@src/lib/shopify/draft-order.ts
@data/products.json
@.env.prod
@.github/workflows/ci.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SHOPIFY_PRODUCT_MAP env var with Zod validation and update product catalog</name>
  <files>
    src/lib/env.ts
    src/lib/product/types.ts
    src/lib/product/catalog.ts
    data/products.json
  </files>
  <action>
**1. Add SHOPIFY_PRODUCT_MAP to env schema (`src/lib/env.ts`):**

Add a new field `SHOPIFY_PRODUCT_MAP` to the Zod schema. It is a required string that must be valid JSON containing a mapping from product IDs to their Shopify GIDs. Use Zod's `.transform()` to parse the JSON and `.pipe()` to validate the parsed structure.

The parsed structure should be: `Record<string, { productId: string; variantId: string }>` where each key is a product ID (e.g., `"roller-blind-white"`) and each value contains the Shopify Product GID and ProductVariant GID.

Implementation pattern:
```typescript
SHOPIFY_PRODUCT_MAP: z
  .string()
  .min(1, "SHOPIFY_PRODUCT_MAP is required")
  .transform((val) => JSON.parse(val))
  .pipe(
    z.record(
      z.string(),
      z.object({
        productId: z.string().startsWith("gid://shopify/Product/"),
        variantId: z.string().startsWith("gid://shopify/ProductVariant/"),
      })
    )
  ),
```

Export a type alias for the parsed map: `export type ShopifyProductMap = Record<string, { productId: string; variantId: string }>;`

**2. Remove shopifyProductId and shopifyVariantId from Product type (`src/lib/product/types.ts`):**

Delete the `shopifyProductId` and `shopifyVariantId` fields from the `Product` interface. These values now come from the environment, not the catalog JSON.

**3. Add `getShopifyIds` helper to catalog (`src/lib/product/catalog.ts`):**

Add a new exported function:
```typescript
import env from '@/lib/env';

export function getShopifyIds(productId: string): { productId: string; variantId: string } | undefined {
  return env.SHOPIFY_PRODUCT_MAP[productId];
}
```

This function looks up the Shopify IDs from the validated environment variable. Returns `undefined` if the product ID has no mapping in the env var (product exists in catalog but not yet in Shopify).

**4. Remove Shopify IDs from products.json (`data/products.json`):**

Delete the `"shopifyProductId"` and `"shopifyVariantId"` fields from every product entry. Keep all other metadata (name, slug, category, pricingMatrixPath, image, images, usps, specifications, details) intact.
  </action>
  <verify>
Run `npx tsc --noEmit` — should pass with no errors related to shopifyProductId/shopifyVariantId (draft-order.ts will be updated in Task 2). The only expected error may be in `draft-order.ts` which still references the old field — that is fixed in Task 2. Verify `data/products.json` contains zero occurrences of "shopifyProductId" or "shopifyVariantId" via grep.
  </verify>
  <done>
Product type has no Shopify ID fields. products.json has no Shopify ID values. env.ts validates SHOPIFY_PRODUCT_MAP as JSON with correct GID format. catalog.ts exports getShopifyIds function.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update Draft Order to use env-based IDs and create .env.example</name>
  <files>
    src/lib/shopify/draft-order.ts
    .env.example
    .env.prod
    .github/workflows/ci.yml
  </files>
  <action>
**1. Update draft-order.ts to use getShopifyIds:**

In `src/lib/shopify/draft-order.ts`, replace the current pattern:
```typescript
import { getProduct } from '@/lib/product/catalog';
// ...
const product = getProduct(item.productId);
const variantId = product?.shopifyVariantId;
```

With the new env-based lookup:
```typescript
import { getShopifyIds } from '@/lib/product/catalog';
// ...
const shopifyIds = getShopifyIds(item.productId);
const variantId = shopifyIds?.variantId;
```

Remove the `import { getProduct }` line since draft-order.ts no longer needs the product catalog — it only needs the Shopify ID mapping. The rest of the line item construction (title, priceOverride, customAttributes) uses data from the cart item, not the product catalog, so no other changes are needed.

**2. Create `.env.example`:**

Create a new `.env.example` file (it does not currently exist) with documented placeholder values:

```
# Shopify Store Configuration
SHOPIFY_STORE_DOMAIN=your-store.myshopify.com
SHOPIFY_ADMIN_ACCESS_TOKEN=shpat_xxxxxxxxxxxxxxxxxxxxxxxx
SHOPIFY_API_VERSION=2026-01

# Base URL for canonical URLs and metadata
NEXT_PUBLIC_BASE_URL=https://your-domain.nl

# Shopify Product ID Mapping (JSON)
# Maps internal product IDs to Shopify Product and Variant GIDs.
# Each product in data/products.json needs a corresponding entry here.
# Dev and production stores have different IDs for the same products.
SHOPIFY_PRODUCT_MAP={"roller-blind-white":{"productId":"gid://shopify/Product/000000000","variantId":"gid://shopify/ProductVariant/000000000"},"roller-blind-black":{"productId":"gid://shopify/Product/000000000","variantId":"gid://shopify/ProductVariant/000000000"}}
```

**3. Update `.env.prod` with SHOPIFY_PRODUCT_MAP:**

Read the current `shopifyProductId` and `shopifyVariantId` values from the current `data/products.json` (before Task 1 removes them) and construct the correct SHOPIFY_PRODUCT_MAP value for the production env. The current values are:
- roller-blind-white: productId=`gid://shopify/Product/9275201487085`, variantId=`gid://shopify/ProductVariant/49390577025261`
- roller-blind-black: productId=`gid://shopify/Product/9275201487085`, variantId=`gid://shopify/ProductVariant/49390787821805`

Add to `.env.prod`:
```
SHOPIFY_PRODUCT_MAP={"roller-blind-white":{"productId":"gid://shopify/Product/9275201487085","variantId":"gid://shopify/ProductVariant/49390577025261"},"roller-blind-black":{"productId":"gid://shopify/Product/9275201487085","variantId":"gid://shopify/ProductVariant/49390787821805"}}
```

Also remove the stale `SHOPIFY_PRODUCT_ID` line from `.env.prod` if it still exists.

**4. Add SHOPIFY_PRODUCT_MAP to CI workflow:**

In `.github/workflows/ci.yml`, add `SHOPIFY_PRODUCT_MAP` to the `build` job's `env` section:
```yaml
SHOPIFY_PRODUCT_MAP: ${{ secrets.SHOPIFY_PRODUCT_MAP }}
```

This ensures the build step has the env var available for Zod validation at build time.
  </action>
  <verify>
Run `npx tsc --noEmit` — should compile cleanly with zero errors. Grep the entire `src/` directory for `shopifyProductId` and `shopifyVariantId` — should return zero results except possibly in TypeScript declaration files. Verify `.env.example` exists and contains `SHOPIFY_PRODUCT_MAP`. Verify `.env.prod` contains `SHOPIFY_PRODUCT_MAP` and no `SHOPIFY_PRODUCT_ID`. Verify `.github/workflows/ci.yml` includes `SHOPIFY_PRODUCT_MAP` in the build job env.
  </verify>
  <done>
draft-order.ts resolves Shopify variant IDs from environment via getShopifyIds. .env.example documents SHOPIFY_PRODUCT_MAP with placeholder GID format. .env.prod has the correct production mapping. CI workflow passes SHOPIFY_PRODUCT_MAP to build step.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes — no TypeScript errors
2. `grep -r "shopifyProductId\|shopifyVariantId" data/ src/` returns zero matches
3. `grep "SHOPIFY_PRODUCT_MAP" src/lib/env.ts` confirms env var is validated
4. `grep "SHOPIFY_PRODUCT_MAP" .env.example` confirms documentation exists
5. `grep "SHOPIFY_PRODUCT_MAP" .github/workflows/ci.yml` confirms CI has the env var
6. `grep "getShopifyIds" src/lib/shopify/draft-order.ts` confirms draft order uses env-based lookup
7. `node -e "const j = require('./data/products.json'); console.log(JSON.stringify(j).includes('shopify'))"` prints `false`
</verification>

<success_criteria>
- products.json has zero Shopify ID fields
- Shopify IDs resolved entirely from SHOPIFY_PRODUCT_MAP environment variable
- Build fails if SHOPIFY_PRODUCT_MAP is missing or malformed (Zod validation)
- Draft Orders reference the correct Shopify variant IDs from env
- .env.example documents the required format with placeholder GIDs
- Same code deployable to dev and prod with different env vars
</success_criteria>

<output>
After completion, create `.planning/phases/20-environment-configuration/20-01-SUMMARY.md`
</output>
