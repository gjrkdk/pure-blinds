---
milestone: v1.5
audited: 2026-02-27
status: tech_debt
scores:
  requirements: 15/15
  phases: 4/4
  integration: 14/15
  flows: 3/3
gaps:
  requirements: []
  integration:
    - from: "Phase 26"
      to: "Phase 24"
      issue: "begin_checkout double-fires in production — trackBeginCheckout() at line 113 dispatches via sendGtagEvent AND window.gtag event_callback at lines 121-127 both reach window.gtag when GA_MEASUREMENT_ID is set"
      affected_requirements: ["ECOM-03"]
  flows: []
tech_debt:
  - phase: 26-analytics-gap-closure
    items:
      - "begin_checkout double-fire in production: trackBeginCheckout (line 113) calls sendGtagEvent which calls window.gtag in production, then lines 121-127 call window.gtag again with event_callback — GA4 receives 2 begin_checkout events per checkout. Fix: guard line 113 with if (!GA_MEASUREMENT_ID) or remove it."
  - phase: 24-e-commerce-events
    items:
      - "PurchaseTracker mounted in root layout.tsx instead of /bevestiging/page.tsx — useEffect fires on every page navigation, not just /bevestiging. Deduplication prevents double-counting but architectural deviation from plan."
      - "sessionStorage purchase_snapshot cross-origin survival through Shopify redirect unverified in production — requires live checkout test"
accepted_deviations:
  - id: "CONS-01"
    description: "Main banner shows 'Voorkeuren' instead of 'Weiger alles' — user chose this intentionally"
    accepted_by: "user"
    date: "2026-02-27"
  - id: "CONS-02"
    description: "Equal-prominence requirement applies to Accepteer alles vs Voorkeuren buttons on main banner — user accepted two-click reject flow"
    accepted_by: "user"
    date: "2026-02-27"
---

# Milestone v1.5 Audit: Analytics & Privacy (Post Phase 26)

**Audited:** 2026-02-27 (re-audit after Phase 26 gap closure)
**Status:** tech_debt
**Scores:** Requirements 15/15 | Phases 4/4 | Integration 14/15 | Flows 3/3

## Requirements Coverage (3-Source Cross-Reference)

| REQ-ID | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Integration | Final Status |
|--------|----------------|---------------------|-----------------|-------------|--------------|
| GA4-01 | Phase 23: SATISFIED | 23-01: listed | [x] Complete | WIRED | **satisfied** |
| GA4-02 | Phase 26: SATISFIED | 23-01, 26-01: listed | [x] Complete | WIRED | **satisfied** |
| GA4-03 | Phase 23: SATISFIED | 23-01: listed | [x] Complete | WIRED | **satisfied** |
| ECOM-01 | Phase 24: SATISFIED | 24-01: listed | [x] Complete | WIRED | **satisfied** |
| ECOM-02 | Phase 24: SATISFIED | 24-01: listed | [x] Complete | WIRED | **satisfied** |
| ECOM-03 | Phase 26: SATISFIED | 24-02, 26-01: listed | [x] Complete | WIRED (double-fire) | **satisfied** (tech debt) |
| ECOM-04 | Phase 24: SATISFIED | 24-02: listed | [x] Complete | WIRED | **satisfied** |
| ECOM-05 | Phase 24: SATISFIED | 24-02: listed | [x] Complete | WIRED | **satisfied** |
| ECOM-06 | Phase 24: SATISFIED | 24-02: listed | [x] Complete | WIRED | **satisfied** |
| CONS-01 | Phase 25: SATISFIED | 25-01, 25-02: listed | [x] Complete | WIRED | **satisfied** (accepted deviation) |
| CONS-02 | Phase 25: NEEDS HUMAN | 25-01: listed | [x] Complete | WIRED | **satisfied** (accepted deviation) |
| CONS-03 | Phase 25: NEEDS HUMAN | 25-01: listed | [x] Complete | WIRED | **satisfied** |
| CONS-04 | Phase 25: SATISFIED | 25-01: listed | [x] Complete | WIRED | **satisfied** |
| CONS-05 | Phase 25: NEEDS HUMAN | 25-01: listed | [x] Complete | WIRED | **satisfied** |
| CONS-06 | Phase 25: SATISFIED | 25-01: listed | [x] Complete | WIRED | **satisfied** |

**Satisfied:** 15/15 | **Partial:** 0 | **Unsatisfied:** 0 | **Orphaned:** 0

## Changes Since Previous Audit

The first audit (pre-Phase 26) found 4 gaps. Phase 26 resolved the critical two:

| Gap | Previous Status | Resolution |
|-----|----------------|------------|
| ECOM-03: begin_checkout empty body | unsatisfied | **Fixed** — Phase 26 T1 (commit 60827ac) restored sendGtagEvent call |
| GA4-02: accept_incoming missing | partial | **Fixed** — Phase 26 T2 (commit 292bfee) added accept_incoming: true |
| CONS-01: "Voorkeuren" vs "Weiger alles" | partial | **Accepted deviation** — user chose to keep Voorkeuren on main banner |
| CONS-02: equal prominence mismatch | partial | **Accepted deviation** — user accepted two-click reject flow |

## Phase Verification Summary

| Phase | VERIFICATION Status | Score | Issues |
|-------|-------------------|-------|--------|
| 23 — GA4 Foundation | human_needed | 5/5 automated | 3 runtime items need browser verification (cookie, DebugView, cross-domain) |
| 24 — E-Commerce Events | passed | 8/8 | PurchaseTracker placement deviation (functionally correct) |
| 25 — Cookie Consent Banner | human_needed | 7/7 automated | 7 runtime items need browser verification; user visual checkpoint passed |
| 26 — Analytics Gap Closure | passed | 6/6 | begin_checkout double-fire (tech debt) |

## Integration Wiring

| Export | Source | Consumer | Status |
|--------|--------|----------|--------|
| sendGtagEvent | gtag.ts | index.ts (all events) | WIRED |
| GA_MEASUREMENT_ID | gtag.ts → index.ts | layout.tsx, cart-summary.tsx | WIRED |
| trackPageView | index.ts | analytics-provider.tsx | WIRED |
| trackViewItem | index.ts | dimension-configurator.tsx | WIRED |
| trackAddToCart | index.ts | dimension-configurator.tsx | WIRED |
| trackBeginCheckout | index.ts | cart-summary.tsx | WIRED (double-fire in production) |
| trackPurchase | index.ts | purchase-tracker.tsx | WIRED |
| AnalyticsProvider | analytics-provider.tsx | layout.tsx | WIRED |
| PurchaseTracker | purchase-tracker.tsx | layout.tsx | WIRED |
| CookieConsentBanner | cookie-consent-banner.tsx | layout.tsx | WIRED |
| window.gtag consent update | cookie-consent-banner.tsx | Phase 23 Script 1 | WIRED |
| decorateWithGlLinker | cart-summary.tsx | Shopify redirect URL | WIRED |
| accept_incoming: true | layout.tsx Script 3 | Return from Shopify _gl parsing | WIRED |

**Integration score:** 14/15 — one double-fire issue

## E2E Flow Analysis

| Flow | Status | Notes |
|------|--------|-------|
| First Visit → Consent → Browse → Add to Cart → Checkout → Shopify → /bevestiging | COMPLETE | begin_checkout double-fires but funnel is end-to-end functional |
| Return Visit → Consent Restored → Browse → Events Fire | COMPLETE | onConsent hook restores analytics_storage on every page load |
| Consent Denied → Browse → No Tracking Cookies, Site Functional | COMPLETE | Consent Mode v2 basic mode; disablePageInteraction absent |

## Tech Debt

**Total: 3 items across 2 phases**

### Phase 26: Analytics Gap Closure

1. **begin_checkout double-fire** — `cart-summary.tsx` line 113 calls `trackBeginCheckout()` which routes through `sendGtagEvent()` → `window.gtag()` in production. Lines 121-127 then call `window.gtag('event', 'begin_checkout', ...)` again via `event_callback`. GA4 receives 2 `begin_checkout` events per checkout initiation.
   - **Fix:** Guard line 113 with `if (!GA_MEASUREMENT_ID)` so it only fires the dev console log, or remove the call entirely since the `window.gtag` event_callback call handles production.

### Phase 24: E-Commerce Events

2. **PurchaseTracker in layout vs /bevestiging** — `PurchaseTracker` is mounted in root `layout.tsx` instead of `/bevestiging/page.tsx`. The `useEffect` fires on every page navigation. Deduplication (sessionStorage + localStorage) prevents double-counting. Functionally correct but architecturally deviates from plan.

3. **sessionStorage cross-origin survival** — `purchase_snapshot` written before Shopify redirect must survive cross-origin round-trip. Unverified in production with a real Shopify checkout. Standard browser behavior preserves sessionStorage for same-tab navigation (including external redirects), but edge cases (Safari ITP, mobile browsers) need production testing.

## Accepted Deviations

| ID | Deviation | Accepted By |
|----|-----------|-------------|
| CONS-01 | Main banner shows "Voorkeuren" (Preferences) instead of "Weiger alles" (Reject all) — requires two clicks to reject | User (intentional choice) |
| CONS-02 | Equal-prominence requirement applies to accept vs preferences buttons on main banner, not accept vs reject directly | User (intentional choice) |

---

_Audited: 2026-02-27 (post Phase 26 gap closure)_
_Auditor: Claude (gsd-audit-milestone)_
