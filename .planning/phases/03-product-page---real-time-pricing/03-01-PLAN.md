---
phase: 03-product-page---real-time-pricing
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/app/products/[productId]/page.tsx
  - src/components/dimension-configurator.tsx
  - package.json
autonomous: false

must_haves:
  truths:
    - "Product page displays product name and description"
    - "Customer can enter width dimension in cm"
    - "Customer can enter height dimension in cm"
    - "Price updates automatically after user stops typing (debounced)"
    - "Invalid dimensions show inline error messages below inputs"
    - "Loading state visible while price is calculating"
    - "Mobile devices show numeric keyboard for dimension inputs"
    - "Page is responsive on mobile and desktop"
  artifacts:
    - path: "src/app/products/[productId]/page.tsx"
      provides: "Server Component product page shell"
      min_lines: 15
    - path: "src/components/dimension-configurator.tsx"
      provides: "Client Component with dimension inputs, debounced pricing, error/loading states"
      min_lines: 80
  key_links:
    - from: "src/components/dimension-configurator.tsx"
      to: "/api/pricing"
      via: "fetch POST in useEffect triggered by debounced values"
      pattern: "fetch.*api/pricing.*POST"
    - from: "src/app/products/[productId]/page.tsx"
      to: "src/components/dimension-configurator.tsx"
      via: "import and render as Client Component island"
      pattern: "import.*DimensionConfigurator"
---

<objective>
Build the product page with an interactive dimension configurator that calls the pricing API in real-time.

Purpose: This is the core customer-facing interface where users configure custom textile dimensions and see prices. It connects the pricing engine (Phase 2) to a usable frontend.
Output: A working product page at /products/[productId] with dimension inputs, debounced price updates, inline validation errors, and loading states.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-product-page---real-time-pricing/03-CONTEXT.md
@.planning/phases/03-product-page---real-time-pricing/03-RESEARCH.md
@src/lib/pricing/types.ts
@src/app/api/pricing/route.ts
@src/lib/pricing/validator.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install use-debounce and create product page Server Component</name>
  <files>package.json, src/app/products/[productId]/page.tsx</files>
  <action>
1. Install use-debounce: `npm install use-debounce`

2. Create `src/app/products/[productId]/page.tsx` as a Server Component (NO 'use client' directive):

- This is a dynamic route page. Use Next.js 16 async params pattern:
  ```
  export default async function ProductPage({
    params
  }: {
    params: Promise<{ productId: string }>
  }) {
    const { productId } = await params
  ```

- Use hardcoded mock product data for now (real Shopify product fetching comes later):
  ```
  const product = {
    id: productId,
    name: "Custom Textile",
    description: "Premium custom-dimension textile. Enter your desired width and height to get an instant price quote."
  }
  ```

- Render a clean product page layout with Tailwind:
  - Centered container with max-width (max-w-2xl mx-auto)
  - Product name as h1
  - Product description as paragraph
  - Import and render `<DimensionConfigurator />` as a Client Component island below the product info
  - Pass productId as prop to DimensionConfigurator

- Add appropriate padding and spacing for mobile (px-4 py-8)
  </action>
  <verify>TypeScript compiles: `npx tsc --noEmit` passes. File exists at src/app/products/[productId]/page.tsx.</verify>
  <done>Product page Server Component exists with mock data, imports and renders DimensionConfigurator Client Component.</done>
</task>

<task type="auto">
  <name>Task 2: Create dimension configurator Client Component with debounced pricing</name>
  <files>src/components/dimension-configurator.tsx</files>
  <action>
Create `src/components/dimension-configurator.tsx` with `'use client'` directive.

Props interface: `{ productId: string }` (used for future cart integration)

**State management:**
- `width` and `height` as string state (controlled inputs, user sees raw value)
- `debouncedWidth` and `debouncedHeight` via `useDebounce(value, 400)` from `use-debounce`
- `price` as `number | null` (cents from API)
- `loading` as boolean
- `error` as `string | null` (API or validation error message)
- `fieldErrors` as `{ width?: string; height?: string }` (inline per-field errors)

**Input fields (IMPORTANT - follow research anti-patterns):**
- Use `<input type="text" inputMode="decimal" pattern="[0-9]*">` -- NOT type="number" (React has documented bugs with number inputs)
- Each input has a label ("Width (cm)", "Height (cm)")
- Show inline error below each input in red text (text-red-600 text-sm mt-1) when fieldErrors has content
- Add `aria-invalid` and `aria-describedby` for accessibility

**Client-side validation (immediate, no debounce):**
- On each onChange, parse value with parseInt
- If value is non-empty and not a valid integer, set field error "Enter a whole number"
- If value < 10, set field error "Minimum 10cm"
- If value > 200, set field error "Maximum 200cm"
- If valid or empty, clear the field error
- This gives instant feedback without waiting for API

**Debounced API call (useEffect):**
- Trigger when debouncedWidth AND debouncedHeight both have valid numeric values (10-200 range)
- Use the `ignore` flag pattern for race condition prevention (per RESEARCH.md Pattern 3):
  ```
  useEffect(() => {
    let ignore = false
    // ... fetch logic, check !ignore before setState
    return () => { ignore = true }
  }, [debouncedWidth, debouncedHeight])
  ```
- POST to `/api/pricing` with `{ width: Number(debouncedWidth), height: Number(debouncedHeight) }`
- On success (response.ok): set price to `data.priceInCents`, clear error
- On 400 error: parse Zod field errors from `data.details` array, map to fieldErrors
- On other error / catch: set error to "Unable to calculate price"
- Set loading=true before fetch, loading=false in finally (only if !ignore)

**Price display:**
- Use `Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' })` to format `price / 100`
- Show price prominently below the inputs (text-3xl font-bold)
- When loading: show "Calculating..." text in place of price
- When error (non-field): show error message in red in place of price
- When no price yet (initial state): show nothing or subtle prompt like "Enter dimensions to see price"

**Layout and styling (Tailwind):**
- Inputs side by side on desktop (grid grid-cols-2 gap-4), stacked on mobile (grid-cols-1 on small screens)
- Price display below inputs with margin
- Clean, minimal design matching "clean, simple display" from CONTEXT.md
- Responsive: works on 320px mobile up to desktop

**Do NOT:**
- Add 'use client' to the page.tsx (only on this component)
- Use type="number" on inputs
- Show the normalized/rounded dimension to the user (user sees their raw input, rounding is silent)
- Use lodash debounce (use the use-debounce library hook)
- Build a custom debounce with setTimeout
  </action>
  <verify>
1. `npx tsc --noEmit` passes
2. `npm run build` succeeds
3. Start dev server (`npm run dev`) and navigate to http://localhost:3000/products/test-product -- page loads without errors
4. Enter width=100 and height=100, verify price appears after ~400ms debounce
5. Enter width=5, verify inline error "Minimum 10cm" appears immediately
6. Enter width=999, verify inline error "Maximum 200cm" appears immediately
  </verify>
  <done>
- Dimension configurator renders two inputs with labels and cm units
- Debounced API calls happen ~400ms after user stops typing
- Price displays formatted as currency (e.g., "$45.00")
- Loading state shows "Calculating..." during API call
- Invalid dimensions show inline red error text below the relevant input
- Race conditions prevented via ignore flag pattern
- Mobile shows numeric keyboard (inputMode="decimal")
- Layout responsive (side-by-side on desktop, stacked on mobile)
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Product page with interactive dimension configurator at /products/[productId]. Customers enter width and height, see real-time debounced price updates, inline validation errors, and loading states. Mobile-responsive layout with numeric keyboard.</what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`
2. Open http://localhost:3000/products/test-product in browser
3. Verify product name "Custom Textile" and description are visible
4. Enter width=100 and height=150 -- after brief pause, price should appear (formatted as "$XX.XX")
5. Change width to 50 -- price should update after debounce
6. Enter width=5 -- should show inline error "Minimum 10cm" immediately (no API call)
7. Enter width=300 -- should show inline error "Maximum 200cm" immediately
8. Clear width field -- price should disappear, no error shown
9. Open browser DevTools Network tab, type rapidly -- confirm debounced calls (not one per keystroke)
10. (Optional) Open on mobile or use Chrome DevTools device mode -- verify numeric keyboard hint and stacked layout
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (no type errors)
- `npm run build` succeeds (production build works)
- Product page loads at /products/[productId] without console errors
- Price calculation works end-to-end: input -> debounce -> API -> display
- Validation errors appear inline for out-of-range dimensions
- No race conditions (rapid typing shows final correct price)
</verification>

<success_criteria>
- Product page displays product information at /products/[productId]
- Width and height inputs accept values with cm labels
- Price updates ~400ms after user stops typing (debounced, not per keystroke)
- Inline validation errors shown for dimensions outside 10-200cm range
- Loading indicator visible during price calculation
- Error message shown if API call fails
- Mobile numeric keyboard triggered by inputMode="decimal"
- Responsive layout (side-by-side inputs on desktop, stacked on mobile)
</success_criteria>

<output>
After completion, create `.planning/phases/03-product-page---real-time-pricing/03-01-SUMMARY.md`
</output>
