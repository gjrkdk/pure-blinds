---
phase: 25-cookie-consent-banner
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - src/components/analytics/cookie-consent-banner.tsx
  - src/app/globals.css
  - src/app/layout.tsx
autonomous: true
requirements: [CONS-01, CONS-02, CONS-03, CONS-04, CONS-05, CONS-06]

must_haves:
  truths:
    - "A Dutch-language consent banner appears at the bottom of the page on first visit with 'Accepteer alles' and 'Weiger alles' buttons"
    - "Both accept and reject buttons have identical visual size and styling — no dark pattern nudge"
    - "Clicking 'Accepteer alles' calls gtag('consent', 'update', { analytics_storage: 'granted' }) immediately"
    - "Clicking 'Weiger alles' dismisses the banner and no _ga cookie is set"
    - "Consent state is stored in localStorage under key 'cc_cookie' with 365-day expiration"
    - "Returning visitors with existing consent do not see the banner — onConsent fires and re-issues gtag consent update"
    - "The page remains fully scrollable and interactive while the banner is visible"
  artifacts:
    - path: "src/components/analytics/cookie-consent-banner.tsx"
      provides: "CookieConsentBanner client component calling CookieConsent.run()"
      min_lines: 40
    - path: "src/app/globals.css"
      provides: "CSS variable overrides for vanilla-cookieconsent bar theme"
      contains: "#cc-main"
    - path: "src/app/layout.tsx"
      provides: "CookieConsentBanner mounted in body"
      contains: "CookieConsentBanner"
  key_links:
    - from: "src/components/analytics/cookie-consent-banner.tsx"
      to: "window.gtag"
      via: "updateGtagConsent() called from onFirstConsent and onConsent hooks"
      pattern: "gtag.*consent.*update.*analytics_storage"
    - from: "src/app/layout.tsx"
      to: "src/components/analytics/cookie-consent-banner.tsx"
      via: "import and render <CookieConsentBanner />"
      pattern: "CookieConsentBanner"
---

<objective>
Install vanilla-cookieconsent v3.1.0, create the CookieConsentBanner client component with full GA4 Consent Mode v2 integration, style it to match the site design, and mount it in the root layout.

Purpose: This is the key that unlocks the entire GA4 analytics pipeline — Phase 23 defaults all consent to 'denied', and this banner's accept action calls gtag('consent', 'update') to switch analytics_storage to 'granted', enabling _ga cookies, cross-domain linker, and event visibility in GA4 DebugView.

Output: Working consent banner visible on first visit, consent persisted in localStorage, gtag consent update wired on both first consent and returning visits.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-cookie-consent-banner/25-RESEARCH.md

<interfaces>
<!-- Key types and contracts the executor needs. Extracted from codebase. -->

From src/app/layout.tsx (lines 59-101 — where to mount the banner):
```typescript
{GA_MEASUREMENT_ID && (
  <>
    {/* Script 1: consent-init inline */}
    <Script id="gtag-consent-init" strategy="afterInteractive" ... />
    {/* Script 2: gtag.js CDN */}
    <Script src={`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`} ... />
    {/* Script 3: config + linker */}
    <Script id="gtag-config" strategy="afterInteractive" ... />
  </>
)}
<AnalyticsProvider />
<PurchaseTracker />
// Mount CookieConsentBanner AFTER PurchaseTracker, OUTSIDE GA_MEASUREMENT_ID conditional
```

From src/lib/analytics.ts:
```typescript
export const GA_MEASUREMENT_ID = process.env.NEXT_PUBLIC_GA4_ID || ''
```

From src/app/globals.css — existing design tokens (CSS custom properties):
```css
:root {
  --background: #ffffff;
  --foreground: #0a0a0a;
  --muted: #737373;
  --border: #e5e5e5;
  --surface: #fafafa;
  --accent: #0a0a0a;
  --accent-foreground: #ffffff;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install vanilla-cookieconsent and create CookieConsentBanner component</name>
  <files>
    package.json
    src/components/analytics/cookie-consent-banner.tsx
  </files>
  <action>
1. Install vanilla-cookieconsent:
   ```bash
   npm install vanilla-cookieconsent@3.1.0
   ```

2. Create `src/components/analytics/cookie-consent-banner.tsx` as a `'use client'` component:

```typescript
'use client'

import { useEffect } from 'react'
import 'vanilla-cookieconsent/dist/cookieconsent.css'
import * as CookieConsent from 'vanilla-cookieconsent'

function updateGtagConsent() {
  if (typeof window === 'undefined' || typeof window.gtag !== 'function') return
  window.gtag('consent', 'update', {
    analytics_storage: CookieConsent.acceptedCategory('analytics') ? 'granted' : 'denied',
  })
}

export function CookieConsentBanner() {
  useEffect(() => {
    CookieConsent.run({
      cookie: {
        name: 'cc_cookie',
        useLocalStorage: true,
        expiresAfterDays: 365,
      },
      guiOptions: {
        consentModal: {
          layout: 'bar inline',
          position: 'bottom',
          equalWeightButtons: true,
          flipButtons: false,
        },
      },
      onFirstConsent: updateGtagConsent,
      onConsent: updateGtagConsent,
      categories: {
        necessary: { enabled: true, readOnly: true },
        analytics: {
          autoClear: {
            cookies: [{ name: /^_ga/ }, { name: '_gid' }],
          },
        },
      },
      language: {
        default: 'nl',
        translations: {
          nl: {
            consentModal: {
              description:
                'We gebruiken cookies om te begrijpen hoe bezoekers onze site gebruiken, zodat we hem steeds beter kunnen maken. Je kunt altijd weigeren zonder dat dit invloed heeft op je bestelling. <a href="/privacybeleid" class="cc__link">Privacybeleid</a>',
              acceptAllBtn: 'Accepteer alles',
              acceptNecessaryBtn: 'Weiger alles',
            },
          },
        },
      },
    })
  }, [])

  return null
}
```

Key decisions:
- Do NOT gate on GA_MEASUREMENT_ID — banner must always show (CONS-01). The `window.gtag?.()` guard degrades gracefully when GA4 is absent.
- `useLocalStorage: true` — stores consent in localStorage, not a browser cookie (CONS-04, locked decision).
- `expiresAfterDays: 365` — 12-month GDPR recommendation (locked decision, NOT the library default of 182).
- `equalWeightButtons: true` — identical button styling (CONS-02, locked decision).
- Both `onFirstConsent` AND `onConsent` wired to `updateGtagConsent` — `onConsent` fires on every page load when consent exists, which is how consent is restored after Shopify checkout redirect (CONS-05).
- `autoClear.cookies` with `_ga` regex and `_gid` — clears GA cookies when user rejects after previously accepting.
- No `disablePageInteraction` (defaults to false) — site remains fully usable without consent (CONS-06).
- No `title` field in the nl translation — the `bar inline` layout is minimal, title is omitted per CONTEXT.md decisions.

Note: The `window.gtag` type may not be declared. If TypeScript complains, add a type declaration at the top of the file:
```typescript
declare global {
  interface Window {
    gtag?: (...args: unknown[]) => void
  }
}
```
Check existing analytics files for how gtag is typed — reuse the same pattern.
  </action>
  <verify>
    <automated>cd /Users/robinkonijnendijk/Desktop/projects/pure-blinds && npx tsc --noEmit 2>&1 | head -30 && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - vanilla-cookieconsent@3.1.0 installed in package.json
    - CookieConsentBanner component exists at src/components/analytics/cookie-consent-banner.tsx
    - Component is a 'use client' component that calls CookieConsent.run() in useEffect
    - TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Add CSS overrides and mount banner in root layout</name>
  <files>
    src/app/globals.css
    src/app/layout.tsx
  </files>
  <action>
1. Append vanilla-cookieconsent CSS variable overrides to the BOTTOM of `src/app/globals.css`:

```css
/* vanilla-cookieconsent bar theme — aligned to site design tokens */
#cc-main {
  --cc-font-family: var(--font-jakarta), system-ui, sans-serif;
  --cc-primary-color: var(--foreground);
  --cc-btn-primary-bg: var(--accent);
  --cc-btn-primary-color: var(--accent-foreground);
  --cc-btn-secondary-bg: transparent;
  --cc-btn-secondary-color: var(--foreground);
  --cc-btn-secondary-border-color: var(--border);
  --cc-bg: #ffffff;
  --cc-text: var(--foreground);
  --cc-link-color: var(--foreground);
  --cc-border-radius: 0rem;
  --cc-bar-border-radius: 0rem;
}
```

The overrides use the site's existing CSS custom properties from :root so the banner matches the design system. `--cc-border-radius: 0rem` removes border radius because the bar spans full viewport width. The secondary button (reject) gets transparent background with border — equal prominence to primary (accept).

2. Mount `<CookieConsentBanner />` in `src/app/layout.tsx`:

- Add import: `import { CookieConsentBanner } from '@/components/analytics/cookie-consent-banner'`
- Add `<CookieConsentBanner />` AFTER `<PurchaseTracker />` and OUTSIDE the `{GA_MEASUREMENT_ID && (...)}` conditional block.
- The component renders null — no visual output from React; the library injects its own DOM.

The mount point MUST be outside the GA_MEASUREMENT_ID conditional. The banner must always show in production regardless of whether GA4 is configured (CONS-01). The updateGtagConsent function already guards with `window.gtag?.()`.
  </action>
  <verify>
    <automated>cd /Users/robinkonijnendijk/Desktop/projects/pure-blinds && npm run build 2>&1 | tail -20</automated>
  </verify>
  <done>
    - globals.css has #cc-main CSS variable overrides using site design tokens
    - layout.tsx imports and renders CookieConsentBanner after PurchaseTracker
    - CookieConsentBanner is outside the GA_MEASUREMENT_ID conditional
    - Build succeeds without errors
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. TypeScript compiles without errors (`npx tsc --noEmit`)
3. `src/components/analytics/cookie-consent-banner.tsx` exists and contains:
   - `'use client'` directive
   - `CookieConsent.run()` call in useEffect
   - `useLocalStorage: true` in cookie config
   - `expiresAfterDays: 365` in cookie config
   - `equalWeightButtons: true` in guiOptions
   - Both `onFirstConsent` and `onConsent` callbacks
   - `gtag('consent', 'update', { analytics_storage: ... })` in updateGtagConsent
4. `src/app/globals.css` contains `#cc-main` CSS variable overrides
5. `src/app/layout.tsx` imports and renders `<CookieConsentBanner />`
</verification>

<success_criteria>
- vanilla-cookieconsent@3.1.0 is installed
- CookieConsentBanner component created with full configuration matching all locked decisions
- CSS overrides theme the banner to match site design
- Banner mounted in root layout outside GA_MEASUREMENT_ID conditional
- Build passes
</success_criteria>

<output>
After completion, create `.planning/phases/25-cookie-consent-banner/25-01-SUMMARY.md`
</output>
