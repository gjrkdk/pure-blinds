---
phase: 22-checkout-order-tracking
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/dimension-configurator.tsx
  - src/components/cart/cart-item.tsx
  - src/components/cart/cart-summary.tsx
  - src/app/winkelwagen/page.tsx
  - src/app/bevestiging/page.tsx
  - src/components/cart/clear-cart-on-mount.tsx
  - src/app/api/verify-order/route.ts
autonomous: true
requirements: [CHKOUT-01, CHKOUT-02]

must_haves:
  truths:
    - "Product configurator shows calculated price with 'incl. 21% BTW' inline after the amount"
    - "Cart line item prices display 'incl. 21% BTW' label"
    - "Cart total shows 'incl. BTW' label"
    - "Visiting /bevestiging without a valid order_id query param redirects to homepage"
    - "Cart clears only after Shopify API confirms the order ID is valid"
    - "If Shopify verification fails, cart stays intact"
    - "Empty cart page shows 'Je winkelwagen is leeg' with link to homepage"
  artifacts:
    - path: "src/app/api/verify-order/route.ts"
      provides: "Shopify order verification endpoint"
      exports: ["GET"]
    - path: "src/components/cart/clear-cart-on-mount.tsx"
      provides: "Smart cart clearing with order verification"
    - path: "src/components/dimension-configurator.tsx"
      provides: "VAT-inclusive price display"
      contains: "incl. 21% BTW"
    - path: "src/components/cart/cart-item.tsx"
      provides: "Cart line item VAT label"
      contains: "incl. BTW"
    - path: "src/components/cart/cart-summary.tsx"
      provides: "Cart total VAT label"
      contains: "incl. BTW"
  key_links:
    - from: "src/components/cart/clear-cart-on-mount.tsx"
      to: "src/app/api/verify-order/route.ts"
      via: "fetch call to verify order before clearing"
      pattern: "fetch.*api/verify-order"
    - from: "src/app/bevestiging/page.tsx"
      to: "src/components/cart/clear-cart-on-mount.tsx"
      via: "passes order_id prop for verification"
      pattern: "orderId.*ClearCartOnMount"
---

<objective>
Add VAT-inclusive price labels throughout the purchase flow and implement smart cart clearing that only triggers after verified order completion.

Purpose: Customers see transparent VAT-inclusive pricing before checkout (Dutch regulatory expectation), and the cart is protected from accidental clearing when visiting the confirmation page without a valid order.

Output: Updated price displays with "incl. 21% BTW" labels on configurator, cart items, and cart total. Confirmation page that verifies order_id against Shopify API before clearing cart, with redirect to homepage when no valid order parameter is present.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/components/dimension-configurator.tsx
@src/components/cart/cart-item.tsx
@src/components/cart/cart-summary.tsx
@src/app/bevestiging/page.tsx
@src/components/cart/clear-cart-on-mount.tsx
@src/app/winkelwagen/page.tsx
@src/lib/shopify/client.ts
@src/lib/pricing/calculator.ts
@src/lib/cart/store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add VAT-inclusive price labels to configurator, cart items, and cart total</name>
  <files>
    src/components/dimension-configurator.tsx
    src/components/cart/cart-item.tsx
    src/components/cart/cart-summary.tsx
  </files>
  <action>
    **Per locked decision: inline "incl. 21% BTW" after price amounts. No price breakdown, no separate BTW line.**

    **dimension-configurator.tsx** — In the price display section (the `price !== null` branch around line 280-285):
    - Change the price label from just `{formatPrice(price)}` to `{formatPrice(price)} incl. 21% BTW`
    - The "incl. 21% BTW" text should be styled as smaller/muted text inline after the price. Use a `<span>` with `text-base font-normal text-muted ml-1` (the price itself is `text-3xl font-semibold`).
    - Remove the separate "Prijs" label line above (line 281 `<p className="text-sm text-muted mb-1">Prijs</p>`) — the BTW label makes this redundant.

    **cart-item.tsx** — In the unit price display (around line 69):
    - Currently shows `{formatPrice(item.priceInCents)}{!isSample && " per stuk"}`
    - Change to `{formatPrice(item.priceInCents)}{!isSample && " per stuk"} incl. BTW`
    - Note: Use the shorter "incl. BTW" on cart line items (not "incl. 21% BTW") since it appears in a tighter layout. Append as plain text after the existing content within the same `<p>` tag.

    **Also in cart-item.tsx** — The line total display (around line 91):
    - Currently shows `{formatPrice(lineTotal)}`
    - No change needed here — the line total inherits the BTW label from the unit price and the cart total has its own label.

    **cart-summary.tsx** — In the total price display (around line 78-83):
    - After the "Totaal" label and `{formatPrice(totalPrice)}` amount, add the BTW label.
    - Change the total amount span to: `{formatPrice(totalPrice)} <span className="text-xs font-normal text-muted ml-1">incl. BTW</span>`
    - The subtotal line (around line 69) does NOT need the label — only the final total per locked decision "Cart total shows 'incl. BTW' label".
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors. Visually inspect that:
    - Configurator price shows e.g. "€42,50 incl. 21% BTW"
    - Cart line item shows "€42,50 per stuk incl. BTW"
    - Cart total shows "€42,50 incl. BTW"
  </verify>
  <done>
    All three price display locations show inline BTW labels per the locked decision format. No separate BTW breakdown lines exist.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement smart cart clearing with Shopify order verification on confirmation page</name>
  <files>
    src/app/api/verify-order/route.ts
    src/components/cart/clear-cart-on-mount.tsx
    src/app/bevestiging/page.tsx
    src/app/winkelwagen/page.tsx
  </files>
  <action>
    **Per locked decisions:**
    - Visiting /bevestiging without valid order parameter → redirect silently to homepage
    - Verify order ID against Shopify API before clearing cart (don't trust URL params)
    - If verification fails → cart stays intact (safe default)
    - Cart clears silently — no toast or notification
    - Empty cart state: "Je winkelwagen is leeg" with "Terug naar de winkel" link to homepage

    **Step 1 — Create `/api/verify-order` route** (`src/app/api/verify-order/route.ts`):

    Create a GET endpoint that accepts `?order_id=XXXXXX` query param.
    - If `order_id` is missing or empty, return `{ valid: false }` with 400 status.
    - Query Shopify Admin GraphQL API to verify the order exists. Use a simple `draftOrder` query:
      ```graphql
      query draftOrderLookup($id: ID!) {
        node(id: $id) {
          ... on DraftOrder {
            id
            status
          }
        }
      }
      ```
    - The `order_id` from the URL might be a numeric Shopify order name/number OR a full GID. Handle both:
      - If it starts with `gid://`, use as-is
      - If it's numeric, construct `gid://shopify/DraftOrder/${order_id}`
    - If node is found and has a valid `id`, return `{ valid: true }`.
    - If node is null or query fails, return `{ valid: false }`.
    - Wrap in try-catch: on any error, return `{ valid: false }` (safe default per decision).
    - Import `createAdminClient` from `@/lib/shopify/client`.

    **Step 2 — Rewrite `ClearCartOnMount`** (`src/components/cart/clear-cart-on-mount.tsx`):

    Transform from unconditional clear to verification-gated clear:
    - Accept an `orderId` prop (string or undefined).
    - If `orderId` is undefined or empty, do nothing (the page component handles the redirect).
    - On mount, call `fetch(\`/api/verify-order?order_id=${orderId}\`)`.
    - If response is ok and `{ valid: true }`, call `clearCart()`.
    - If verification fails, do NOT clear cart (safe default).
    - Keep it as a client component (`'use client'`).
    - Also clean up the `checkout_started` localStorage key on successful verification (it was set in cart-summary.tsx during checkout).

    **Step 3 — Update confirmation page** (`src/app/bevestiging/page.tsx`):

    - The page already reads `order_id` from searchParams.
    - Add redirect logic: if `order_id` is undefined or empty, use Next.js `redirect('/')` to silently redirect to homepage. Import `redirect` from `next/navigation`.
    - Pass `orderId={order_id}` prop to `<ClearCartOnMount orderId={order_id} />`.
    - Keep all existing confirmation page content unchanged (per locked decision: "Keep the existing confirmation page content").

    **Step 4 — Update empty cart state** (`src/app/winkelwagen/page.tsx`):

    Per locked decision, the empty cart message should link to homepage, not /producten:
    - Change the empty state message from "Uw winkelwagen is leeg" to "Je winkelwagen is leeg" (per decision: "Je winkelwagen is leeg").
    - Change the CTA link `href` from `/producten` to `/` (per decision: "Terug naar de winkel" link to homepage).
    - Change button text from "Begin met configureren" to "Terug naar de winkel".
  </action>
  <verify>
    Run `npm run build` — no TypeScript errors. Verify:
    1. The `/api/verify-order?order_id=test` endpoint returns `{ valid: false }` (since test is not a real order)
    2. The confirmation page redirects to homepage when visited without `?order_id=`
    3. The empty cart page shows "Je winkelwagen is leeg" with link to `/`
  </verify>
  <done>
    - `/bevestiging` without valid order_id redirects to homepage
    - Cart is cleared only after successful Shopify API verification of order_id
    - Failed verification leaves cart intact
    - Empty cart page shows Dutch message with homepage link
  </done>
</task>

</tasks>

<verification>
1. `npm run build` completes without errors
2. Price displays show "incl. 21% BTW" (configurator) and "incl. BTW" (cart items, cart total)
3. `/bevestiging` without `order_id` param redirects to `/`
4. `/api/verify-order?order_id=invalid` returns `{ valid: false }`
5. Empty cart page shows "Je winkelwagen is leeg" with "Terug naar de winkel" linking to `/`
</verification>

<success_criteria>
- All price displays include inline VAT labels per the locked format decisions
- Confirmation page gate: no valid order = redirect to homepage
- Cart clearing is verification-gated via Shopify API check
- Empty cart state uses homepage link per decision
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/22-checkout-order-tracking/22-01-SUMMARY.md`
</output>
