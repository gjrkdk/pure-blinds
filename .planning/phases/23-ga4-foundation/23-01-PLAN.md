---
phase: 23-ga4-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/analytics/gtag.ts
  - src/lib/analytics/index.ts
  - src/components/analytics/analytics-provider.tsx
  - src/app/layout.tsx
autonomous: true
requirements: [GA4-01, GA4-02, GA4-03]

must_haves:
  truths:
    - "No _ga cookie appears in browser storage before user grants consent"
    - "GA4 DebugView shows page_view events on every App Router route change without full page reload"
    - "Cross-domain linker appends _gl parameter to links pointing to Shopify checkout domain"
    - "Analytics does not fire in development or preview deployments"
    - "Development console logs what WOULD be sent to GA4"
  artifacts:
    - path: "src/lib/analytics/gtag.ts"
      provides: "gtag wrapper with production guard, dev console logging, TypeScript declarations"
      exports: ["sendGtagEvent", "GA_MEASUREMENT_ID"]
    - path: "src/lib/analytics/index.ts"
      provides: "Public analytics API for page views, designed for Phase 24/25 extension"
      exports: ["trackPageView"]
    - path: "src/components/analytics/analytics-provider.tsx"
      provides: "Client component that fires page_view on pathname changes (not query param changes)"
      contains: "usePathname"
    - path: "src/app/layout.tsx"
      provides: "Three Script tags in correct order (consent defaults → gtag.js → config+linker) + AnalyticsProvider mount"
      contains: "gtag-consent-init"
  key_links:
    - from: "src/components/analytics/analytics-provider.tsx"
      to: "src/lib/analytics/index.ts"
      via: "import trackPageView"
      pattern: "import.*trackPageView.*from.*@/lib/analytics"
    - from: "src/lib/analytics/index.ts"
      to: "src/lib/analytics/gtag.ts"
      via: "import sendGtagEvent"
      pattern: "import.*sendGtagEvent.*from.*./gtag"
    - from: "src/app/layout.tsx"
      to: "src/components/analytics/analytics-provider.tsx"
      via: "AnalyticsProvider component mount"
      pattern: "<AnalyticsProvider"
    - from: "src/app/layout.tsx"
      to: "https://www.googletagmanager.com/gtag/js"
      via: "Script src with NEXT_PUBLIC_GA4_ID"
      pattern: "googletagmanager.com/gtag/js"
---

<objective>
Set up the GA4 analytics foundation: load gtag.js with Consent Mode v2 defaults (all 4 parameters denied before gtag.js fires), configure cross-domain linker for Shopify checkout session continuity, and track SPA route changes as page_view events on pathname changes only.

Purpose: Phase 23 establishes the analytics infrastructure that Phase 24 (e-commerce events) and Phase 25 (cookie consent) will extend. The module is designed as a thin extensible API — all GA4 interaction goes through `src/lib/analytics/` so future phases add functions without restructuring.

Output: Analytics module (`src/lib/analytics/`), route tracking provider component, root layout integration with three Script tags in mandatory Consent Mode v2 order.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/23-ga4-foundation/23-RESEARCH.md

@src/app/layout.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create analytics module with gtag wrapper and public API</name>
  <files>src/lib/analytics/gtag.ts, src/lib/analytics/index.ts</files>
  <action>
Create `src/lib/analytics/gtag.ts`:
- Declare global `Window` interface extensions for `gtag` and `dataLayer`
- Export `GA_MEASUREMENT_ID = process.env.NEXT_PUBLIC_GA4_ID`
- Guard: Analytics only fires when `GA_MEASUREMENT_ID` is defined (this naturally blocks dev and preview deployments where the env var is not set — do NOT use `NODE_ENV === 'production'` check because Vercel preview deployments also have `NODE_ENV=production`)
- Export `sendGtagEvent(eventName: string, params?: Record<string, unknown>)`:
  - If `GA_MEASUREMENT_ID` is falsy: `console.log('[Analytics]', eventName, params ?? {})` and return early
  - If production (GA_MEASUREMENT_ID defined): call `window.gtag('event', eventName, params)` with typeof window/gtag safety checks
- Check for `debug_mode=true` URL search param and pass `debug_mode: true` in the config if present (do NOT set `debug_mode: false` to disable — omit entirely when not debugging)

Create `src/lib/analytics/index.ts`:
- Import `sendGtagEvent` and `GA_MEASUREMENT_ID` from `./gtag`
- Export `trackPageView(pathname: string)`: calls `sendGtagEvent('page_view', { page_location: pathname })` — only path, no page title (locked decision)
- Add TSDoc comments marking extension points: "Phase 24 will add: trackViewItem(), trackAddToCart(), trackBeginCheckout(), trackPurchase()" and "Phase 25 will add: updateConsent()"
- Re-export `GA_MEASUREMENT_ID` for use in layout Script tag conditional rendering
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors in new analytics files. Verify exports by checking: `grep -r "export" src/lib/analytics/`
  </verify>
  <done>
Analytics module exists at src/lib/analytics/ with sendGtagEvent (production guard + dev logging) and trackPageView (path only, no title). TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create AnalyticsProvider and integrate GA4 into root layout</name>
  <files>src/components/analytics/analytics-provider.tsx, src/app/layout.tsx</files>
  <action>
Create `src/components/analytics/analytics-provider.tsx`:
- `'use client'` directive at top
- Import `useEffect` from `react`, `usePathname` from `next/navigation`, `trackPageView` from `@/lib/analytics`
- `AnalyticsProvider` component:
  - `const pathname = usePathname()`
  - `useEffect(() => { trackPageView(pathname) }, [pathname])` — fires on initial mount (correct: this IS the landing page view) AND on every pathname change. Query-param-only changes do NOT trigger because usePathname strips query params.
  - Returns `null` (renders nothing)
- Export as named export

Modify `src/app/layout.tsx`:
- Import `Script` from `next/script`
- Import `{ AnalyticsProvider }` from `@/components/analytics/analytics-provider`
- Import `{ GA_MEASUREMENT_ID }` from `@/lib/analytics`
- Inside `<body>`, AFTER `<Footer />`, conditionally render when `GA_MEASUREMENT_ID` is defined:
  1. **Script 1** (inline, id="gtag-consent-init", strategy="afterInteractive"): Initialize dataLayer, define gtag function, call `gtag('consent', 'default', { ad_storage: 'denied', ad_user_data: 'denied', ad_personalization: 'denied', analytics_storage: 'denied' })` — this MUST be first to block _ga cookie before gtag.js loads
  2. **Script 2** (external, src=`https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`, strategy="afterInteractive"): Load gtag.js from CDN — loads AFTER consent defaults are set
  3. **Script 3** (inline, id="gtag-config", strategy="afterInteractive"): `gtag('js', new Date())`, `gtag('config', '${GA_MEASUREMENT_ID}')`, `gtag('set', 'linker', { 'domains': ['${process.env.NEXT_PUBLIC_SHOPIFY_DOMAIN}'] })` — cross-domain linker for Shopify checkout

- Mount `<AnalyticsProvider />` inside `<body>` AFTER children (it renders null, position doesn't matter visually but keep it logical)
- The AnalyticsProvider should be mounted OUTSIDE the GA_MEASUREMENT_ID conditional — it uses the dev console logging path when GA4 is not configured, providing devs visibility into what page views would fire

CRITICAL ordering: Script 1 (consent defaults) → Script 2 (gtag.js CDN) → Script 3 (config + linker). This ordering is mandatory — if consent defaults come AFTER gtag.js loads, _ga cookies will be written before consent is checked.

Do NOT use `@next/third-parties/google` GoogleAnalytics component — it does not support Consent Mode v2 initialization ordering.
  </action>
  <verify>
Run `npx tsc --noEmit` — no type errors. Run `npm run build` — build succeeds. Inspect the layout.tsx output to confirm three Script tags are present in correct order, wrapped in GA_MEASUREMENT_ID conditional.
  </verify>
  <done>
AnalyticsProvider component tracks pathname changes via usePathname. Root layout has three Script tags in correct Consent Mode v2 order (consent defaults → gtag.js → config+linker), conditionally rendered only when NEXT_PUBLIC_GA4_ID is set. Cross-domain linker configured for NEXT_PUBLIC_SHOPIFY_DOMAIN. Build succeeds.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — zero type errors
2. `npm run build` — production build succeeds
3. Inspect `src/app/layout.tsx` — confirm Script tags present in order: consent-init → gtag.js → config
4. Inspect `src/lib/analytics/gtag.ts` — confirm GA_MEASUREMENT_ID guard (not NODE_ENV)
5. Inspect `src/components/analytics/analytics-provider.tsx` — confirm usePathname dependency, not useSearchParams
6. Grep for anti-patterns: no `@next/third-parties`, no `GoogleAnalytics`, no `NODE_ENV === 'production'` guard in analytics files
</verification>

<success_criteria>
- Analytics module at src/lib/analytics/ with extensible public API
- AnalyticsProvider fires page_view on pathname changes only (not query params)
- Root layout loads gtag.js with Consent Mode v2 defaults (all 4 denied) BEFORE gtag.js fires
- Cross-domain linker configured for Shopify checkout domain
- No analytics in dev/preview (guarded by NEXT_PUBLIC_GA4_ID presence, not NODE_ENV)
- Dev console logs analytics events for debugging
- Build passes cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/23-ga4-foundation/23-01-SUMMARY.md`
</output>
