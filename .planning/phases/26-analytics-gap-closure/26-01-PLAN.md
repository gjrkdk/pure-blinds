---
plan: 26-01
phase: 26-analytics-gap-closure
title: "Re-enable begin_checkout with event_callback + fix cross-domain linker"
wave: 1
depends_on: []
requirements:
  - ECOM-03
  - GA4-02
files_modified:
  - src/lib/analytics/index.ts
  - src/components/cart/cart-summary.tsx
  - src/app/layout.tsx
autonomous: true
---

## Goal

`begin_checkout` GA4 event fires reliably for consenting users before Shopify redirect, and cross-domain linker correctly accepts incoming `_gl` parameters on return from Shopify checkout.

## must_haves

Derived goal-backward from phase success criteria:

1. `trackBeginCheckout()` in `src/lib/analytics/index.ts` has a working function body that dispatches the `begin_checkout` GA4 event via `sendGtagEvent`
2. `cart-summary.tsx` uses `event_callback` + `event_timeout: 2000` pattern so the Shopify redirect only fires AFTER the GA4 event is dispatched (or after the 2s safety timeout)
3. The `begin_checkout` event is fired in the API success branch (after `invoiceUrl` is available), NOT before the fetch call
4. When `window.gtag` is not a function (ad blocker) OR `GA_MEASUREMENT_ID` is falsy (dev/preview), the redirect fires immediately without waiting
5. `accept_incoming: true` is present in the `gtag('set', 'linker', ...)` call in `layout.tsx` Script 3
6. The build passes with no TypeScript errors (`npm run build`)

## Context for Executor

### Current State

- `trackBeginCheckout()` in `src/lib/analytics/index.ts` lines 65-67 is an empty function body (disabled in commit 530fe83)
- The call site in `cart-summary.tsx` line 77 invokes `trackBeginCheckout()` BEFORE the fetch call — this placement is wrong for the callback pattern
- `layout.tsx` Script 3 (line 92) has `gtag('set', 'linker', { 'domains': ['...'] })` but is missing `'accept_incoming': true`

### Key Decisions from Research

- **Option A chosen for begin_checkout architecture:** Re-enable `trackBeginCheckout` in `index.ts` as a standard fire-and-forget event (no callback concern in the analytics module). Handle the `event_callback` + `event_timeout` redirect pattern directly in `cart-summary.tsx` using raw `window.gtag`. The analytics module should not know about redirects.
- **Consent-denied behavior is correct by design:** When `analytics_storage` is denied, `event_callback` still fires (gtag processes internally) but no data reaches GA4. This is the correct GDPR posture. The `event_timeout: 2000` ensures the redirect fires regardless.
- **Open question mitigation:** Research flagged uncertainty about whether `event_callback` fires in denied-consent Basic Mode. As safety: check `CookieConsent.acceptedCategory('analytics')` — if false, skip gtag call entirely and redirect immediately. This makes code paths explicit.

### Anti-Patterns to Avoid

- Do NOT call `trackBeginCheckout` before the API response — the event must fire only in the success branch where `invoiceUrl` exists
- Do NOT use `event_callback` without `event_timeout` — ad blockers can prevent callback from ever firing
- Do NOT import `CookieConsent` in `index.ts` — keep consent checks at the call site only

## Tasks

<task id="26-01-T1">
<title>Re-enable trackBeginCheckout function body in analytics/index.ts</title>
<type>code</type>
<file>src/lib/analytics/index.ts</file>
<what>
Replace the empty `trackBeginCheckout` function body with a working implementation that calls `sendGtagEvent`.
</what>
<how>
1. In `src/lib/analytics/index.ts`, find the `trackBeginCheckout` function (lines 65-67)
2. Replace the empty body and underscore-prefixed params with a real implementation:

```typescript
export function trackBeginCheckout(items: GA4EcommerceItem[], totalValue: number): void {
  sendGtagEvent('begin_checkout', {
    currency: 'EUR',
    value: totalValue,
    items,
  })
}
```

3. Update the JSDoc comment above the function — remove the TODO and "Not currently firing" text. Replace with:

```typescript
/**
 * Track a begin_checkout event when a user initiates checkout.
 *
 * Fire-and-forget: dispatches the event via sendGtagEvent.
 * The call site in cart-summary.tsx handles event_callback + redirect timing separately.
 */
```

This function becomes a standard analytics event like trackViewItem and trackAddToCart. The redirect-timing concern is handled at the call site, not here.
</how>
</task>

<task id="26-01-T2">
<title>Implement event_callback redirect pattern in cart-summary.tsx + add accept_incoming to layout.tsx</title>
<type>code</type>
<files>
- src/components/cart/cart-summary.tsx
- src/app/layout.tsx
</files>
<what>
1. Move begin_checkout event firing from before the fetch call to the API success branch, using window.gtag with event_callback + event_timeout to gate the Shopify redirect
2. Add `'accept_incoming': true` to the cross-domain linker config in layout.tsx
</what>
<how>
### Part A: cart-summary.tsx

**Imports to add** (top of file):
```typescript
import { GA_MEASUREMENT_ID } from '@/lib/analytics/gtag'
```

Keep the existing `import { trackBeginCheckout } from '@/lib/analytics'` — it is still used for dev console logging (sendGtagEvent logs in dev when GA_MEASUREMENT_ID is falsy).

**Step 1: Remove the current trackBeginCheckout call at lines 77-85.** Delete the entire block:
```typescript
    trackBeginCheckout(
      items.map(item => ({
        item_id: item.productId,
        item_name: item.productName,
        price: item.priceInCents / 100,
        quantity: item.quantity,
      })),
      getTotalPrice() / 100
    )
```

**Step 2: In the success branch** (inside `if (response.ok && data.invoiceUrl)`), replace the current redirect line:
```typescript
        window.location.href = decorateWithGlLinker(data.invoiceUrl);
```

With the event_callback + event_timeout redirect pattern:
```typescript
        const shopifyUrl = decorateWithGlLinker(data.invoiceUrl)

        const checkoutItems = items.map(item => ({
          item_id: item.productId,
          item_name: item.productName,
          price: item.priceInCents / 100,
          quantity: item.quantity,
        }))

        // Fire begin_checkout for dev console logging (no-op in prod, but keeps dev parity)
        trackBeginCheckout(checkoutItems, getTotalPrice() / 100)

        const redirectToShopify = () => {
          window.location.href = shopifyUrl
        }

        // Gate redirect behind event_callback so GA4 dispatches before navigation
        if (typeof window.gtag === 'function' && GA_MEASUREMENT_ID) {
          window.gtag('event', 'begin_checkout', {
            currency: 'EUR',
            value: getTotalPrice() / 100,
            items: checkoutItems,
            event_callback: redirectToShopify,
            event_timeout: 2000,
          })
        } else {
          redirectToShopify()
        }
```

**Important:** The `sessionStorage.setItem` and `clearCart()` calls must remain BEFORE this new redirect block (they are already positioned correctly in the success branch). The `useCartStore.getState().clearCart()` and `localStorage.removeItem("checkout_started")` lines stay exactly where they are.

The final order inside the success branch must be:
1. Build snapshot + write to sessionStorage
2. clearCart() + localStorage cleanup
3. Build shopifyUrl + checkoutItems
4. trackBeginCheckout (dev logging)
5. event_callback redirect pattern

### Part B: layout.tsx

In `src/app/layout.tsx`, find Script 3 (id="gtag-config"), line 92:
```javascript
gtag('set', 'linker', { 'domains': ['${process.env.NEXT_PUBLIC_SHOPIFY_DOMAIN}'] });
```

Replace with:
```javascript
gtag('set', 'linker', { 'domains': ['${process.env.NEXT_PUBLIC_SHOPIFY_DOMAIN}'], 'accept_incoming': true });
```

This is a single property addition. No other changes to layout.tsx.
</how>
</task>

## Verification

After both tasks are complete:

1. **Build check:** `npm run build` must pass with zero TypeScript errors
2. **Static verification of trackBeginCheckout body:** `src/lib/analytics/index.ts` — function body calls `sendGtagEvent('begin_checkout', ...)` (not empty, no underscore-prefixed params)
3. **Static verification of event_callback pattern:** `cart-summary.tsx` — `window.gtag('event', 'begin_checkout', { ... event_callback: redirectToShopify, event_timeout: 2000 })` present in the `if (response.ok && data.invoiceUrl)` success branch
4. **Static verification of accept_incoming:** `layout.tsx` — `'accept_incoming': true` present in the `gtag('set', 'linker', ...)` call
5. **No trackBeginCheckout call before fetch:** Confirm the old call at line 77 (before the try/fetch block) has been removed
6. **Fallback path exists:** When `window.gtag` is not a function or `GA_MEASUREMENT_ID` is falsy, `redirectToShopify()` is called directly (else branch)
