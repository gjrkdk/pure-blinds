---
phase: 01-project-setup
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/shopify/client.ts
  - src/app/api/health/route.ts
autonomous: false

user_setup:
  - service: shopify
    why: "Shopify Admin API access for Draft Orders and product management"
    env_vars:
      - name: SHOPIFY_STORE_DOMAIN
        source: "Your Shopify store URL (e.g., textile-shop-dev.myshopify.com)"
      - name: SHOPIFY_ADMIN_ACCESS_TOKEN
        source: "Shopify Admin -> Settings -> Apps -> Develop apps -> Create app -> Configure Admin API scopes (write_draft_orders, read_products, write_products) -> Install app -> Reveal token once"
    dashboard_config:
      - task: "Create Shopify Partner account and development store"
        location: "partners.shopify.com -> Dev stores -> Add dev store"
      - task: "Create custom app with Admin API scopes"
        location: "Shopify Admin -> Settings -> Apps -> Develop apps -> Create an app"
      - task: "Configure Admin API scopes: write_draft_orders, read_products, write_products"
        location: "App settings -> Configuration -> Admin API integration"

must_haves:
  truths:
    - "Shopify Admin API responds to a test query with valid store data"
    - "Health endpoint at /api/health returns store name and connection status"
    - "Application connects to Shopify using validated environment credentials"
  artifacts:
    - path: "src/lib/shopify/client.ts"
      provides: "Shopify API client configured for custom app"
      contains: "shopifyApi"
      exports: ["createAdminClient"]
    - path: "src/app/api/health/route.ts"
      provides: "Health check endpoint verifying Shopify connectivity"
      exports: ["GET"]
  key_links:
    - from: "src/lib/shopify/client.ts"
      to: "src/lib/env.ts"
      via: "imports validated env vars"
      pattern: "import.*env.*from.*lib/env"
    - from: "src/app/api/health/route.ts"
      to: "src/lib/shopify/client.ts"
      via: "imports createAdminClient"
      pattern: "import.*createAdminClient.*from.*shopify/client"
---

<objective>
Create the Shopify API client and a health check endpoint that verifies the application can connect to the Shopify Admin API with valid credentials.

Purpose: Proves end-to-end connectivity between the Next.js app and Shopify, which is the foundation for all checkout and product operations in later phases.
Output: Working Shopify client module and /api/health endpoint returning store info.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-project-setup/01-RESEARCH.md
@.planning/phases/01-project-setup/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Shopify client and health endpoint</name>
  <files>
    src/lib/shopify/client.ts
    src/app/api/health/route.ts
  </files>
  <action>
    1. Create `src/lib/shopify/client.ts`:
       - Import the web-api adapter: `import '@shopify/shopify-api/adapters/web-api'`
       - Import `shopifyApi` and `ApiVersion` from `@shopify/shopify-api`
       - Import env from `@/lib/env`
       - Initialize shopifyApi with:
         - apiKey: empty string (not needed for custom app)
         - apiSecretKey: empty string (not needed for custom app)
         - scopes: empty array (custom apps use access tokens, not OAuth)
         - hostName: env.SHOPIFY_STORE_DOMAIN
         - apiVersion: Use the appropriate ApiVersion enum value for 2026-01 (check the library exports — likely ApiVersion.January26 or similar). If the exact enum is unclear, use the string "2026-01" and cast as needed.
         - isEmbeddedApp: false
         - isCustomStoreApp: true
       - Export a `createAdminClient()` function that returns a new Graphql client with domain and accessToken from env

    2. Create `src/app/api/health/route.ts`:
       - Export async GET handler
       - Use createAdminClient() to make a simple GraphQL query: `{ shop { name url myshopifyDomain } }`
       - On success: return JSON `{ status: "connected", shop: { name, url, domain } }`
       - On error: return JSON `{ status: "error", message: error.message }` with 500 status
       - Wrap in try/catch for clean error handling

    DO NOT expose the access token in the response.
    DO NOT use NEXT_PUBLIC_ for any Shopify credentials.
    DO NOT use REST API — use GraphQL Admin API only.
  </action>
  <verify>
    Run `npm run build` to confirm TypeScript compiles.
    After user provides real credentials in .env.local:
    Run `npm run dev` then `curl http://localhost:3000/api/health`
    Expected: JSON response with status "connected" and shop name.
  </verify>
  <done>
    Shopify client module at src/lib/shopify/client.ts configured for custom app with web-api adapter.
    Health check endpoint at /api/health returns Shopify store info on GET request.
  </done>
</task>

<task type="checkpoint:human-action" gate="blocking">
  <name>Task 2: Configure Shopify store and credentials</name>
  <action>
    Set up Shopify development store and configure real API credentials.
  </action>
  <instructions>
    Before the health endpoint can work, you need real Shopify credentials:

    1. **Create Shopify Partner account** (if you don't have one):
       - Go to https://partners.shopify.com
       - Sign up for free Partner account

    2. **Create development store**:
       - In Partner Dashboard, go to "Dev stores"
       - Click "Add dev store"
       - Name it (e.g., "textile-shop-dev")
       - Click "Create dev store"

    3. **Create custom app**:
       - In your dev store admin (https://your-store.myshopify.com/admin)
       - Go to Settings -> Apps and sales channels
       - Click "Develop apps"
       - Click "Create an app", name it "Textile Shop Backend"

    4. **Configure API scopes**:
       - Click "Configure Admin API scopes"
       - Select: write_draft_orders, read_products, write_products
       - Click "Save"

    5. **Install and get token**:
       - Click "Install app"
       - In "Admin API access token" section, click "Reveal token once"
       - COPY THE TOKEN IMMEDIATELY (only shown once!)

    6. **Update .env.local**:
       ```
       SHOPIFY_STORE_DOMAIN=your-actual-store.myshopify.com
       SHOPIFY_ADMIN_ACCESS_TOKEN=shpat_your_actual_token
       SHOPIFY_API_VERSION=2026-01
       ```

    7. **Verify connection**:
       - Run `npm run dev`
       - Visit http://localhost:3000/api/health
       - Should see: `{"status":"connected","shop":{"name":"..."}}`
  </instructions>
  <resume-signal>Type "connected" once the health endpoint returns your store name, or describe any issues.</resume-signal>
</task>

</tasks>

<verification>
1. `npm run build` compiles without TypeScript errors
2. `curl http://localhost:3000/api/health` returns JSON with status "connected" and real shop name
3. Shopify store domain and access token in .env.local are real (not placeholders)
4. No credentials exposed in client-side code or API responses
</verification>

<success_criteria>
- Shopify API client configured with web-api adapter for Next.js
- Health endpoint proves live connectivity to Shopify Admin API
- Real store name appears in health check response
- All Shopify credentials are server-side only
</success_criteria>

<output>
After completion, create `.planning/phases/01-project-setup/01-02-SUMMARY.md`
</output>
