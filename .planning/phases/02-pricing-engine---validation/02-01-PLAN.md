---
phase: 02-pricing-engine---validation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/pricing/types.ts
  - src/lib/pricing/validator.ts
  - src/lib/pricing/calculator.ts
autonomous: true

must_haves:
  truths:
    - "Dimensions between 10 and 200 cm are accepted as valid input"
    - "Dimensions below 10 or above 200 are rejected with descriptive error messages"
    - "Non-numeric dimension inputs are rejected"
    - "Normalized dimensions are always multiples of 10 (e.g., 71 becomes 80, 80 stays 80)"
    - "Price calculation produces consistent results for the same normalized dimensions (e.g., 15x25 and 20x30 yield the same price)"
    - "Prices are always returned as integer cents with no fractional component"
    - "Out-of-bounds matrix lookups throw descriptive errors rather than returning undefined"
  artifacts:
    - path: "src/lib/pricing/types.ts"
      provides: "Domain types for pricing matrix, API request/response"
      contains: "PricingMatrixData"
    - path: "src/lib/pricing/validator.ts"
      provides: "Zod validation schema for dimension inputs"
      exports: ["DimensionInputSchema", "DimensionInput"]
    - path: "src/lib/pricing/calculator.ts"
      provides: "Pure pricing calculation functions"
      exports: ["normalizeDimension", "dimensionToIndex", "calculatePrice", "formatPrice"]
  key_links:
    - from: "src/lib/pricing/calculator.ts"
      to: "data/pricing-matrix.json"
      via: "JSON import"
      pattern: "import.*pricing-matrix"
    - from: "src/lib/pricing/calculator.ts"
      to: "src/lib/pricing/types.ts"
      via: "imports PricingResponse type"
      pattern: "import.*PricingResponse.*from.*types"
    - from: "src/lib/pricing/validator.ts"
      to: "zod"
      via: "Zod schema definition"
      pattern: "import.*from.*zod"
---

<objective>
Create the pure pricing library: TypeScript types, Zod validation schemas, and calculator functions for dimension normalization and matrix-based price lookup.

Purpose: This is the core pricing domain logic with zero Shopify dependencies, enabling reuse in future app extraction. All monetary values use integer cents.
Output: Three files in src/lib/pricing/ that can be imported by the API route handler (Plan 02) and tested independently.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-pricing-engine---validation/02-RESEARCH.md

@data/pricing-matrix.json
@src/lib/env.ts
@tsconfig.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create pricing types and Zod validation schema</name>
  <files>src/lib/pricing/types.ts, src/lib/pricing/validator.ts</files>
  <action>
    Create `src/lib/pricing/types.ts` with these types:
    - `PricingMatrixData` interface matching the structure of `data/pricing-matrix.json` (version, lastUpdated, description, currency, priceUnit: 'cents', dimensions with width/height DimensionConfig, matrix: number[][])
    - `DimensionConfig` interface (min, max, step as numbers, unit: 'cm')
    - `PricingRequest` interface ({ width: number, height: number })
    - `PricingResponse` interface ({ priceInCents: number, normalizedWidth: number, normalizedHeight: number, originalWidth: number, originalHeight: number })
    - `PricingErrorResponse` interface ({ error: string, details?: unknown })

    Create `src/lib/pricing/validator.ts` with:
    - Import `z` from 'zod' (already installed at v4.3.6)
    - `DimensionInputSchema` - z.object with:
      - width: z.number().min(10, 'Width must be at least 10cm').max(200, 'Width must not exceed 200cm')
      - height: z.number().min(10, 'Height must be at least 10cm').max(200, 'Height must not exceed 200cm')
    - Export `DimensionInput` type using z.infer<typeof DimensionInputSchema>
    - Use .safeParse() pattern (NOT .parse()) - the schema itself does not call parse, consumers will call safeParse()

    Important: These files must have ZERO imports from Shopify, Next.js, or any framework. Pure TypeScript + Zod only.
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Verify `src/lib/pricing/types.ts` has no import from shopify or next.
    Verify `src/lib/pricing/validator.ts` only imports from 'zod'.
  </verify>
  <done>
    types.ts exports PricingMatrixData, DimensionConfig, PricingRequest, PricingResponse, PricingErrorResponse.
    validator.ts exports DimensionInputSchema and DimensionInput type.
    Both files compile without errors and have zero framework dependencies.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create pure pricing calculator functions</name>
  <files>src/lib/pricing/calculator.ts</files>
  <action>
    Create `src/lib/pricing/calculator.ts` with these pure functions:

    1. `normalizeDimension(dimension: number): number`
       - Formula: `Math.ceil(dimension / 10) * 10`
       - Rounds up to nearest 10cm increment
       - Examples: 71 -> 80, 80 -> 80, 10 -> 10, 10.1 -> 20

    2. `dimensionToIndex(normalizedDimension: number): number`
       - Formula: `(normalizedDimension / 10) - 1`
       - Maps 10cm -> index 0, 20cm -> index 1, ..., 200cm -> index 19

    3. `calculatePrice(width: number, height: number): PricingResponse`
       - Import pricing matrix from `@/../data/pricing-matrix.json` (use resolveJsonModule, path alias goes to src/ so use relative path `../../../data/pricing-matrix.json` OR configure the import path correctly)
       - NOTE: The tsconfig has `"resolveJsonModule": true` and paths `"@/*": ["./src/*"]`. Since data/ is outside src/, import using a relative path from the file location: `import pricingData from '../../../data/pricing-matrix.json'`
       - Normalize both dimensions using normalizeDimension()
       - Calculate indices using dimensionToIndex()
       - Bounds check BEFORE array access: if widthIndex < 0 or >= matrix.length, throw Error with descriptive message including the dimension value
       - Same bounds check for heightIndex against matrix[0].length
       - Return PricingResponse object with priceInCents from matrix[widthIndex][heightIndex], normalizedWidth, normalizedHeight, originalWidth (the input width), originalHeight (the input height)
       - All prices are integer cents - no floating point operations on money

    4. `formatPrice(cents: number): string`
       - Returns formatted string like "$10.00" from integer cents
       - Formula: `(cents / 100).toFixed(2)` with $ prefix
       - This is the ONLY place cents are converted to dollars, and only for display

    Important:
    - Import PricingResponse from './types'
    - ZERO imports from Shopify, Next.js, or any framework
    - All functions are pure (no I/O, no side effects, no async)
    - The JSON import is the only "external" dependency and it is static data
  </action>
  <verify>
    Run `npx tsc --noEmit` to confirm no type errors.
    Create a quick verification by running a Node.js script or using the Next.js console:
    ```
    node -e "
      // Verify the module compiles and functions work
      // This runs after tsc confirms types are correct
    "
    ```
    Actually, since these are ESM/TypeScript modules, verify by:
    1. `npx tsc --noEmit` passes
    2. Check that calculator.ts imports from './types' (PricingResponse) and relative JSON path, and no framework modules
    3. Verify the file exports all 4 functions: normalizeDimension, dimensionToIndex, calculatePrice, formatPrice
  </verify>
  <done>
    calculator.ts exports 4 pure functions.
    normalizeDimension(71) would return 80, normalizeDimension(80) returns 80.
    dimensionToIndex(10) returns 0, dimensionToIndex(200) returns 19.
    calculatePrice(10, 10) returns PricingResponse with priceInCents: 1000 (from matrix[0][0]).
    calculatePrice(15, 25) returns same priceInCents as calculatePrice(20, 30) (normalization).
    formatPrice(1000) returns "$10.00".
    Zero Shopify/Next.js dependencies in the file.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. All three files exist: src/lib/pricing/types.ts, validator.ts, calculator.ts
3. `grep -r "shopify\|@shopify" src/lib/pricing/` returns no results (zero Shopify deps)
4. `grep -r "next/server\|NextResponse\|NextRequest" src/lib/pricing/` returns no results (zero Next.js deps)
5. calculator.ts imports PricingResponse from './types' and pricing-matrix.json, returns integer cents from matrix lookup
</verification>

<success_criteria>
- Pure pricing library exists in src/lib/pricing/ with types, validator, and calculator
- All functions are pure TypeScript with zero framework dependencies
- Zod schema validates dimensions in 10-200cm range with custom error messages
- Calculator normalizes dimensions, converts to matrix indices, performs bounds checking, and returns integer cents
- TypeScript compilation succeeds with no errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-pricing-engine---validation/02-01-SUMMARY.md`
</output>
