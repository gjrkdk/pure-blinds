---
phase: 04-cart-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/cart/types.ts
  - src/lib/cart/utils.ts
  - src/lib/cart/store.ts
  - src/components/dimension-configurator.tsx
  - src/app/layout.tsx
  - src/components/cart/cart-icon.tsx
autonomous: true

must_haves:
  truths:
    - "Customer can add a configured item to cart from product page"
    - "Cart icon in header shows item count badge"
    - "Adding same dimensions again increments quantity instead of creating duplicate"
    - "Cart state persists across page refresh (localStorage with 7-day TTL)"
  artifacts:
    - path: "src/lib/cart/types.ts"
      provides: "CartItem and CartState type definitions"
      contains: "CartItem"
    - path: "src/lib/cart/utils.ts"
      provides: "Hash generation for cart item uniqueness"
      exports: ["generateOptionsSignature", "generateCartItemId"]
    - path: "src/lib/cart/store.ts"
      provides: "Zustand store with persist middleware and TTL"
      exports: ["useCartStore"]
    - path: "src/components/cart/cart-icon.tsx"
      provides: "Header cart icon with hydration-safe badge"
      contains: "mounted"
    - path: "src/components/dimension-configurator.tsx"
      provides: "Add to Cart button wired to cart store"
      contains: "addItem"
  key_links:
    - from: "src/components/dimension-configurator.tsx"
      to: "src/lib/cart/store.ts"
      via: "useCartStore addItem call"
      pattern: "useCartStore.*addItem"
    - from: "src/lib/cart/store.ts"
      to: "src/lib/cart/utils.ts"
      via: "generateCartItemId for duplicate detection"
      pattern: "generateCartItemId|generateOptionsSignature"
    - from: "src/components/cart/cart-icon.tsx"
      to: "src/lib/cart/store.ts"
      via: "useCartStore getItemCount selector"
      pattern: "useCartStore.*getItemCount"
    - from: "src/app/layout.tsx"
      to: "src/components/cart/cart-icon.tsx"
      via: "CartIcon rendered in header"
      pattern: "CartIcon"
---

<objective>
Create the cart state management foundation using Zustand with localStorage persistence and 7-day TTL, then wire an "Add to Cart" button into the existing product page dimension configurator and add a cart icon with badge to the site header.

Purpose: Establishes the cart data layer and the primary user action (adding items). Without this, there is no cart to display on the cart page (Plan 02).
Output: Working Zustand cart store, add-to-cart flow on product page, cart icon badge in layout header.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-cart-management/04-CONTEXT.md
@.planning/phases/04-cart-management/04-RESEARCH.md
@src/components/dimension-configurator.tsx
@src/app/layout.tsx
@src/lib/pricing/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create cart types, Zustand store with persist/TTL, and hash utility</name>
  <files>
    src/lib/cart/types.ts
    src/lib/cart/utils.ts
    src/lib/cart/store.ts
    package.json
  </files>
  <action>
    Install zustand: `npm install zustand`

    **src/lib/cart/types.ts** - Cart domain types:
    ```typescript
    interface CartItem {
      id: string              // Generated: `${productId}-${optionsSignature}`
      productId: string
      productName: string
      options: {
        width: number         // Original user-entered dimensions (NOT normalized)
        height: number
      }
      optionsSignature: string // Hash of options for uniqueness
      quantity: number
      priceInCents: number    // Price per single item (from pricing API)
    }
    ```
    Keep types pure (no Zustand dependency). Export CartItem and any input types needed.

    **src/lib/cart/utils.ts** - Hash utility for cart item uniqueness:
    - `generateOptionsSignature(options: { width: number; height: number }): string` - Creates a deterministic hash from dimensions. Use JSON.stringify with sorted keys, then a simple hash (can use btoa or a short hash function since this is client-side - do NOT use Node's crypto module as this runs in browser). The hash just needs to be deterministic and collision-resistant enough for ~400 dimension combos.
    - `generateCartItemId(productId: string, options: { width: number; height: number }): string` - Combines productId with optionsSignature.

    **src/lib/cart/store.ts** - Zustand store with persist middleware:
    - Custom storage wrapper with TTL (7 days = 7 * 24 * 60 * 60 * 1000 ms):
      - `getItem`: Parse stored JSON, check timestamp, return null if expired (lazy cleanup)
      - `setItem`: Wrap state with current timestamp
      - `removeItem`: Standard localStorage.removeItem
    - Store shape (CartState):
      - `items: CartItem[]`
      - `addItem(item: Omit<CartItem, 'id' | 'optionsSignature' | 'quantity'>)`: Generate ID via utils, check if existing item has same ID. If yes, increment quantity. If no, add with quantity 1.
      - `removeItem(itemId: string)`: Filter out item
      - `updateQuantity(itemId: string, quantity: number)`: Update quantity, enforce min 1 max 999. If quantity < 1, do nothing (removal is separate action with confirmation).
      - `clearCart()`: Reset items to []
      - `getTotalPrice()`: Reduce items (priceInCents * quantity)
      - `getItemCount()`: Reduce items (sum of quantities)
    - Use `partialize` to only persist `items` array (not derived values)
    - Use functional state updates everywhere (prevent stale reads from rapid clicks)
    - Storage name: `'cart-storage'`

    Important: Use `createJSONStorage` from `zustand/middleware` for proper persist setup. The custom storage with TTL wraps around localStorage.
  </action>
  <verify>
    Run `npx tsc --noEmit` - no TypeScript errors.
    Verify zustand is in package.json dependencies.
    Verify no Node.js-only imports (crypto module) in cart utils - must work in browser.
  </verify>
  <done>
    Cart types, store, and utils compile without errors. Store exports useCartStore with addItem, removeItem, updateQuantity, clearCart, getTotalPrice, getItemCount. Utils export generateOptionsSignature and generateCartItemId. No Node.js-only APIs used.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire Add-to-Cart button on product page and cart icon in header</name>
  <files>
    src/components/dimension-configurator.tsx
    src/components/cart/cart-icon.tsx
    src/app/layout.tsx
  </files>
  <action>
    **src/components/dimension-configurator.tsx** - Add "Add to Cart" button:
    - Import `useCartStore` from `@/lib/cart/store`
    - Add an "Add to Cart" button below the price display section
    - Button is ONLY enabled when: price is not null AND not loading AND no field errors
    - On click: call `addItem({ productId, productName: 'Custom Textile', options: { width: parseInt(width), height: parseInt(height) }, priceInCents: price })`
    - After adding: show brief success feedback. Use a local state `addedFeedback` that shows "Added to Cart!" for 2 seconds then reverts to "Add to Cart". Disable button during feedback period to prevent double-add.
    - Button styling: Full-width, blue-600 bg, white text, rounded-lg, py-3, disabled:opacity-50 disabled:cursor-not-allowed
    - Accept `productName` as a prop (alongside existing `productId`)

    **src/components/cart/cart-icon.tsx** - Header cart icon with badge:
    - 'use client' component
    - Use mount flag pattern for hydration safety (useState(false) + useEffect setMounted(true))
    - Subscribe to `useCartStore(state => state.getItemCount())`
    - Render a shopping cart SVG icon (simple inline SVG, no icon library needed)
    - When mounted and itemCount > 0: show badge with count (absolute positioned, bg-blue-600, text-white, text-xs, rounded-full, min-w-[1.25rem])
    - Link to `/cart` using Next.js Link component
    - Before mounted: render icon without badge (no hydration mismatch)

    **src/app/layout.tsx** - Add header with cart icon:
    - Import CartIcon component
    - Add a simple header inside body: `<header>` with max-w-4xl mx-auto, flex justify-between, items-center, p-4
    - Left side: Link to "/" with site name or simple text
    - Right side: CartIcon component
    - Keep existing children rendering below header

    **src/app/products/[productId]/page.tsx** - Update to pass productName prop:
    - Add `productName` prop when rendering DimensionConfigurator (use the mock product name already defined in the page)
  </action>
  <verify>
    Run `npx tsc --noEmit` - no TypeScript errors.
    Run `npm run build` - production build succeeds.
    Start dev server, navigate to http://localhost:3000/products/test-product:
    - Enter width=100, height=150, wait for price to appear
    - "Add to Cart" button should become enabled
    - Click "Add to Cart" - button text should change to "Added to Cart!" briefly
    - Cart icon in header should show badge with "1"
    - Refresh page - cart icon should still show "1" (localStorage persistence)
    - Enter same dimensions again, add to cart - badge should show "2" (quantity increment, not new item)
  </verify>
  <done>
    Add-to-Cart button visible and functional on product page when price is calculated. Cart icon in header shows badge with total item count. Same dimensions increment quantity. Cart persists across refresh via localStorage.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with zero errors
2. `npm run build` produces successful production build
3. Full add-to-cart flow works: enter dimensions -> see price -> click Add to Cart -> see feedback -> badge updates
4. Persistence: refresh page, badge still shows count
5. Duplicate handling: add same dimensions twice, only one cart item exists with quantity 2
6. Invalid state: button disabled when no price, when loading, when field errors present
</verification>

<success_criteria>
- Zustand store created with persist middleware and 7-day TTL localStorage
- Add-to-Cart button on product page, enabled only when valid price is shown
- Cart icon with hydration-safe badge in site header
- Same dimensions added twice increments quantity (hash-based uniqueness)
- Cart state survives page refresh
- TypeScript compiles, production build succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/04-cart-management/04-01-SUMMARY.md`
</output>
