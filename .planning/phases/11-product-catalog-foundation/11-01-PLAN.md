---
phase: 11-product-catalog-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/product/types.ts
  - src/lib/product/catalog.ts
  - src/lib/product/data.ts
  - data/products.json
  - data/pricing/rollerblinds-white.json
  - data/pricing/rollerblinds-black.json
  - data/pricing/venetian-blinds-25mm.json
  - data/pricing/custom-textile.json
  - src/lib/pricing/calculator.ts
  - src/lib/pricing/loader.ts
  - src/lib/pricing/types.ts
autonomous: true

must_haves:
  truths:
    - "Product catalog stores 4 products with unique IDs, names, categories, pricingMatrixPath, and Shopify IDs"
    - "Each product references its own pricing matrix JSON file via pricingMatrixPath"
    - "Pricing calculator accepts a pricing matrix as its first parameter (pure function, zero imports)"
    - "Pricing matrix loader reads correct file from filesystem given a path string"
  artifacts:
    - path: "data/products.json"
      provides: "Product catalog with 4 products"
      contains: "pricingMatrixPath"
    - path: "data/pricing/rollerblinds-white.json"
      provides: "White rollerblind pricing matrix"
      contains: "matrix"
    - path: "data/pricing/rollerblinds-black.json"
      provides: "Black rollerblind pricing matrix"
      contains: "matrix"
    - path: "src/lib/product/types.ts"
      provides: "Product and ProductCatalog type definitions"
      exports: ["Product", "ProductCatalog"]
    - path: "src/lib/product/catalog.ts"
      provides: "Product catalog loading utilities"
      exports: ["getProduct", "getAllProducts", "getProductsByCategory"]
    - path: "src/lib/pricing/calculator.ts"
      provides: "Pure pricing calculator accepting matrix parameter"
      exports: ["calculatePrice", "normalizeDimension", "dimensionToIndex", "formatPrice"]
    - path: "src/lib/pricing/loader.ts"
      provides: "Dynamic pricing matrix file loader"
      exports: ["loadPricingMatrix"]
  key_links:
    - from: "data/products.json"
      to: "data/pricing/*.json"
      via: "pricingMatrixPath field references pricing matrix files"
      pattern: "pricingMatrixPath.*data/pricing"
    - from: "src/lib/product/catalog.ts"
      to: "data/products.json"
      via: "Direct JSON import with type assertion"
      pattern: "import.*products\\.json"
    - from: "src/lib/pricing/calculator.ts"
      to: "src/lib/pricing/types.ts"
      via: "PricingMatrixData type parameter"
      pattern: "calculatePrice\\(.*pricingMatrix.*PricingMatrixData"
---

<objective>
Create the multi-product data model and refactor the pricing engine to accept any product's pricing matrix as a parameter.

Purpose: Establishes the foundation for multi-product support — product catalog with Shopify ID mapping, per-product pricing matrices, and a pure pricing calculator that works with any matrix.

Output: Product catalog JSON, per-product pricing matrix files, product types, catalog loader utilities, refactored pricing calculator, pricing matrix loader.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-product-catalog-foundation/11-CONTEXT.md
@.planning/phases/11-product-catalog-foundation/11-RESEARCH.md

Source files to modify:
@src/lib/pricing/calculator.ts
@src/lib/pricing/types.ts
@src/lib/product/data.ts
@data/pricing-matrix.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create product catalog data model with types and JSON data files</name>
  <files>
    src/lib/product/types.ts
    src/lib/product/catalog.ts
    src/lib/product/data.ts
    data/products.json
    data/pricing/rollerblinds-white.json
    data/pricing/rollerblinds-black.json
    data/pricing/venetian-blinds-25mm.json
    data/pricing/custom-textile.json
  </files>
  <action>
    **1. Create `src/lib/product/types.ts`** with Product and ProductCatalog interfaces:
    ```typescript
    export interface Product {
      id: string;           // e.g., 'rollerblinds-white'
      name: string;         // e.g., 'White Rollerblind'
      slug: string;         // e.g., 'white-rollerblind' (URL-friendly)
      category: string;     // e.g., 'rollerblinds' (flat string, not nested)
      description: string;
      pricingMatrixPath: string;  // e.g., '/data/pricing/rollerblinds-white.json'
      shopifyProductId: string;   // e.g., 'gid://shopify/Product/123'
      shopifyVariantId: string;   // e.g., 'gid://shopify/ProductVariant/456'
      details: { label: string; value: string }[];
    }

    export interface ProductCatalog {
      version: string;
      lastUpdated: string;
      products: Product[];
    }
    ```

    **2. Create `data/products.json`** — the product catalog JSON file. Migrate the 4 products from `src/lib/product/data.ts` into this JSON file, adding the new fields. Use placeholder Shopify IDs (these will be configured later when test products are created in Shopify):
    - `rollerblinds-white`: category `rollerblinds`, pricingMatrixPath `/data/pricing/rollerblinds-white.json`, shopifyProductId `gid://shopify/Product/PLACEHOLDER_WHITE`, shopifyVariantId `gid://shopify/ProductVariant/PLACEHOLDER_WHITE`
    - `rollerblinds-black`: category `rollerblinds`, pricingMatrixPath `/data/pricing/rollerblinds-black.json`, shopifyProductId `gid://shopify/Product/PLACEHOLDER_BLACK`, shopifyVariantId `gid://shopify/ProductVariant/PLACEHOLDER_BLACK`
    - `venetian-blinds-25mm`: category `venetian-blinds`, pricingMatrixPath `/data/pricing/venetian-blinds-25mm.json`, shopifyProductId `gid://shopify/Product/PLACEHOLDER_VENETIAN`, shopifyVariantId `gid://shopify/ProductVariant/PLACEHOLDER_VENETIAN`
    - `custom-textile`: category `textiles`, pricingMatrixPath `/data/pricing/custom-textile.json`, shopifyProductId `gid://shopify/Product/PLACEHOLDER_TEXTILE`, shopifyVariantId `gid://shopify/ProductVariant/PLACEHOLDER_TEXTILE`

    Preserve all existing `details` arrays from the current `data.ts`. Use the existing `id` values as the JSON `id` field. For `slug`, use the existing URL-friendly form (which matches how productId is used in routes today). Note: the venetian-blinds-25mm product currently has `id: "10373715755274"` in data.ts — use `venetian-blinds-25mm` as the new canonical id (the key used in the Record).

    **3. Create per-product pricing matrix files** in `data/pricing/`:
    - Copy the existing `data/pricing-matrix.json` content to each of the 4 files: `rollerblinds-white.json`, `rollerblinds-black.json`, `venetian-blinds-25mm.json`, `custom-textile.json`
    - Update the `description` field in each to identify the product (e.g., "White rollerblind pricing matrix")
    - Keep all pricing data identical for now (same matrix values) — prices can be differentiated later
    - Keep the existing `data/pricing-matrix.json` file in place (will be removed in Plan 02 after all references are updated)

    **4. Create `src/lib/product/catalog.ts`** — product loading utilities using direct JSON import:
    ```typescript
    import catalogData from '@/../../data/products.json';
    import type { ProductCatalog, Product } from './types';

    const catalog = catalogData as ProductCatalog;

    export function getProduct(productId: string): Product | undefined {
      return catalog.products.find(p => p.id === productId);
    }

    export function getAllProducts(): Product[] {
      return catalog.products;
    }

    export function getProductsByCategory(category: string): Product[] {
      return catalog.products.filter(p => p.category === category);
    }
    ```

    Note on import path: The data directory is outside `src/`, so the import must use a relative path from the file location or configure the tsconfig paths. Check how the existing `calculator.ts` imports `pricing-matrix.json` (it uses `'../../../data/pricing-matrix.json'`) — follow the same pattern. The catalog.ts file is at `src/lib/product/catalog.ts`, so the relative path to `data/products.json` would be `'../../../data/products.json'`.

    **5. Update `src/lib/product/data.ts`** — Replace the inline product Record with re-exports from the new catalog module. This file currently exports `getProduct`, `getAllProductIds`, `getProductsByCategory` and `ProductData` type. Keep backward compatibility by re-exporting from catalog.ts:
    ```typescript
    // Backward compatibility — delegates to new catalog module
    export type { Product as ProductData } from './types';
    export { getProduct, getAllProducts as getAllProductIds, getProductsByCategory } from './catalog';
    ```

    IMPORTANT: The existing `ProductData` type has `category?: string` (optional) but the new `Product` type has `category: string` (required). Also `getAllProductIds` returns `string[]` but `getAllProducts` returns `Product[]`. Handle this carefully — either:
    (a) Keep `data.ts` as a thin adapter that maps the new types/functions to the old signatures, OR
    (b) Update all consumers to use the new imports directly.

    Option (a) is safer for this plan — update consumers in Plan 02. For `getAllProductIds`, create a wrapper: `export function getAllProductIds(): string[] { return getAllProducts().map(p => p.id); }`
  </action>
  <verify>
    Run `npx tsc --noEmit` to verify all types compile correctly.
    Verify `data/products.json` contains 4 products with all required fields (id, name, slug, category, description, pricingMatrixPath, shopifyProductId, shopifyVariantId, details).
    Verify all 4 pricing matrix files exist in `data/pricing/` and are valid JSON.
    Verify `src/lib/product/catalog.ts` exports `getProduct`, `getAllProducts`, `getProductsByCategory`.
    Verify backward compatibility: existing imports from `@/lib/product/data` still resolve.
  </verify>
  <done>
    Product catalog JSON file at `data/products.json` contains 4 products with full metadata including Shopify IDs and pricingMatrixPath. Per-product pricing matrix files exist in `data/pricing/`. New catalog module (`types.ts`, `catalog.ts`) provides typed product loading. Old `data.ts` re-exports for backward compatibility. TypeScript compiles without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Refactor pricing calculator to accept matrix parameter and create pricing matrix loader</name>
  <files>
    src/lib/pricing/calculator.ts
    src/lib/pricing/loader.ts
    src/lib/pricing/types.ts
  </files>
  <action>
    **1. Refactor `src/lib/pricing/calculator.ts`** — Change `calculatePrice` to accept pricing matrix as first parameter:

    Current signature: `calculatePrice(width: number, height: number): PricingResponse`
    New signature: `calculatePrice(pricingMatrix: PricingMatrixData, width: number, height: number): PricingResponse`

    Changes:
    - REMOVE the top-level import: `import pricingData from '../../../data/pricing-matrix.json';`
    - REMOVE the module-level constant: `const pricing = pricingData as PricingMatrixData;`
    - ADD `pricingMatrix: PricingMatrixData` as first parameter to `calculatePrice`
    - Replace all `pricing.` references inside the function with `pricingMatrix.` (4 occurrences: `pricing.matrix.length`, `pricing.matrix[0].length`, `pricing.dimensions.width`, `pricing.dimensions.height`, `pricing.matrix[widthIndex][heightIndex]`)
    - Keep `normalizeDimension`, `dimensionToIndex`, and `formatPrice` unchanged — they have no matrix dependency
    - Update JSDoc to document the new parameter

    The function becomes a pure function with ZERO module-level imports of data files. It only imports types.

    **2. Verify `src/lib/pricing/types.ts`** — No changes needed. `PricingMatrixData` and `PricingResponse` types already exist and are correct. The `PricingRequest` interface may need updating in Plan 02 (to include productId), but leave it for now.

    **3. Create `src/lib/pricing/loader.ts`** — Dynamic pricing matrix file loader for server-side use:
    ```typescript
    import { promises as fs } from 'fs';
    import path from 'path';
    import type { PricingMatrixData } from './types';

    /**
     * Load pricing matrix from file path (server-side only)
     * @param matrixPath - Relative path from project root (e.g., '/data/pricing/rollerblinds-white.json')
     * @returns Parsed pricing matrix data
     * @throws Error if file not found or invalid JSON
     */
    export async function loadPricingMatrix(matrixPath: string): Promise<PricingMatrixData> {
      const fullPath = path.join(process.cwd(), matrixPath);

      try {
        const fileContent = await fs.readFile(fullPath, 'utf-8');
        return JSON.parse(fileContent) as PricingMatrixData;
      } catch (error) {
        if (error instanceof Error && 'code' in error && (error as NodeJS.ErrnoException).code === 'ENOENT') {
          throw new Error(`Pricing matrix not found: ${matrixPath}`);
        }
        throw new Error(`Failed to load pricing matrix: ${matrixPath}`);
      }
    }
    ```

    IMPORTANT: This file uses Node.js `fs` and `path` — it MUST only be imported in server-side code (API routes, Server Components). Never import in client components.

    **4. After refactoring, run `npx tsc --noEmit`** — This WILL produce errors because the API route (`src/app/api/pricing/route.ts`) still calls `calculatePrice(width, height)` with the old 2-parameter signature. That's expected — Plan 02 will update the API route. To verify this plan compiles correctly in isolation, temporarily check that the errors are ONLY in files that Plan 02 will fix (the API route). If there are errors in files modified by THIS plan, fix them.
  </action>
  <verify>
    Run `npx tsc --noEmit 2>&1 | head -30` and verify:
    - The ONLY TypeScript errors are in `src/app/api/pricing/route.ts` (expected, fixed in Plan 02)
    - No errors in `src/lib/pricing/calculator.ts`, `src/lib/pricing/loader.ts`, or `src/lib/pricing/types.ts`

    Verify `calculatePrice` signature has 3 parameters: `(pricingMatrix: PricingMatrixData, width: number, height: number)`
    Verify `calculator.ts` has NO import of `pricing-matrix.json` (grep for `pricing-matrix` should return nothing)
    Verify `loader.ts` exports `loadPricingMatrix` function
  </verify>
  <done>
    Pricing calculator is a pure function accepting `(pricingMatrix, width, height)` with zero data file imports. Pricing matrix loader can read any matrix file from disk given a path. The only remaining TypeScript error is in the API route (which Plan 02 updates).
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. `data/products.json` exists with 4 products, each having `pricingMatrixPath` pointing to a valid file
2. 4 pricing matrix JSON files exist in `data/pricing/`
3. `src/lib/product/catalog.ts` exports `getProduct`, `getAllProducts`, `getProductsByCategory`
4. `src/lib/pricing/calculator.ts` has `calculatePrice(pricingMatrix, width, height)` signature
5. `src/lib/pricing/loader.ts` exports `loadPricingMatrix`
6. `npx tsc --noEmit` shows errors ONLY in `src/app/api/pricing/route.ts` (expected, fixed by Plan 02)
7. Existing product pages still render (backward compatibility via data.ts re-exports)
</verification>

<success_criteria>
- Product catalog JSON and per-product pricing matrices are created and valid
- Pricing calculator accepts matrix as parameter (pure function, zero data imports)
- Pricing matrix loader can read files dynamically from disk
- TypeScript compiles with only expected errors in API route (to be fixed in Plan 02)
- Backward compatibility maintained for existing product page imports
</success_criteria>

<output>
After completion, create `.planning/phases/11-product-catalog-foundation/11-01-SUMMARY.md`
</output>
