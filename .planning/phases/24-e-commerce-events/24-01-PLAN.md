---
phase: 24-e-commerce-events
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/analytics/index.ts
  - src/components/dimension-configurator.tsx
autonomous: true
requirements: [ECOM-01, ECOM-02]

must_haves:
  truths:
    - "GA4 DebugView shows a view_item event with correct item_id (product slug), item_name, and VAT-inclusive EUR price when a user opens a product detail page and a price loads"
    - "GA4 DebugView shows an add_to_cart event with item_id, item_name, EUR price, and width_cm/height_cm custom parameters when a user adds an item to cart"
    - "view_item fires only once per product page visit even when the user changes dimensions multiple times"
  artifacts:
    - path: "src/lib/analytics/index.ts"
      provides: "GA4 e-commerce event functions"
      exports: ["trackViewItem", "trackAddToCart", "trackBeginCheckout", "trackPurchase"]
    - path: "src/components/dimension-configurator.tsx"
      provides: "view_item and add_to_cart event triggers"
      contains: "trackViewItem"
  key_links:
    - from: "src/components/dimension-configurator.tsx"
      to: "src/lib/analytics/index.ts"
      via: "import { trackViewItem, trackAddToCart }"
      pattern: "import.*trackViewItem.*trackAddToCart.*from.*@/lib/analytics"
    - from: "src/lib/analytics/index.ts"
      to: "src/lib/analytics/gtag.ts"
      via: "sendGtagEvent calls"
      pattern: "sendGtagEvent\\('view_item'"
---

<objective>
Add GA4 e-commerce event functions to the analytics module and wire view_item + add_to_cart events into DimensionConfigurator.

Purpose: Enable product view and cart addition tracking in GA4 for funnel analysis. These are the first two steps of the e-commerce funnel.
Output: Extended analytics module with 4 event functions; DimensionConfigurator firing view_item on first price load and add_to_cart on cart addition.
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/24-e-commerce-events/24-CONTEXT.md
@.planning/phases/24-e-commerce-events/24-RESEARCH.md
@.planning/phases/23-ga4-foundation/23-01-SUMMARY.md
@src/lib/analytics/gtag.ts
@src/lib/analytics/index.ts
@src/components/dimension-configurator.tsx
@src/lib/cart/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add GA4 e-commerce event functions to analytics module</name>
  <files>src/lib/analytics/index.ts</files>
  <action>
Extend `src/lib/analytics/index.ts` with four typed e-commerce event functions that call the existing `sendGtagEvent()` wrapper. Follow the pattern already established by `trackPageView()`.

1. Define a `GA4EcommerceItem` interface:
   - `item_id: string` (product slug, e.g. "wit-rolgordijn" per locked decision)
   - `item_name: string` (product display name)
   - `price: number` (EUR decimal, NOT cents — caller must divide by 100)
   - `quantity: number`
   - `item_category?: string` (optional, e.g. "rolgordijnen")
   - `width_cm?: number` (custom param per locked decision — add_to_cart only)
   - `height_cm?: number` (custom param per locked decision — add_to_cart only)

2. Export `trackViewItem(item: GA4EcommerceItem): void`
   - Calls `sendGtagEvent('view_item', { currency: 'EUR', value: item.price, items: [item] })`

3. Export `trackAddToCart(item: GA4EcommerceItem): void`
   - Calls `sendGtagEvent('add_to_cart', { currency: 'EUR', value: item.price * item.quantity, items: [item] })`

4. Export `trackBeginCheckout(items: GA4EcommerceItem[], totalValue: number): void`
   - Calls `sendGtagEvent('begin_checkout', { currency: 'EUR', value: totalValue, items })`

5. Export `trackPurchase(transactionId: string, items: GA4EcommerceItem[], totalValue: number): void`
   - Calls `sendGtagEvent('purchase', { transaction_id: transactionId, currency: 'EUR', value: totalValue, items })`

6. Also export the `GA4EcommerceItem` type so consumers can use it.

Keep the existing `trackPageView` and `GA_MEASUREMENT_ID` re-export intact. Update the Phase 24/25 extension point comments to reflect that Phase 24 functions are now implemented.

No additional guards needed in these wrapper functions — `sendGtagEvent()` already handles GA_MEASUREMENT_ID guard and debug_mode.
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors in src/lib/analytics/index.ts. Verify the file exports trackViewItem, trackAddToCart, trackBeginCheckout, trackPurchase, and GA4EcommerceItem.</verify>
  <done>src/lib/analytics/index.ts exports all 4 e-commerce event functions and the GA4EcommerceItem type, all calling sendGtagEvent with GA4 recommended parameter structure including currency: 'EUR'.</done>
</task>

<task type="auto">
  <name>Task 2: Wire view_item and add_to_cart events into DimensionConfigurator</name>
  <files>src/components/dimension-configurator.tsx</files>
  <action>
Import `trackViewItem` and `trackAddToCart` from `@/lib/analytics` into DimensionConfigurator.

**view_item event (ECOM-01):**

Add a `useRef(false)` called `viewItemFiredRef` to prevent firing view_item on every price update (per Pitfall 4 from RESEARCH.md). Add a `useEffect` that depends on `price`, `productId`, and `productName`:

```typescript
import { useState, useEffect, useRef } from "react";

const viewItemFiredRef = useRef(false);

useEffect(() => {
  if (price === null || viewItemFiredRef.current) return;
  viewItemFiredRef.current = true;
  trackViewItem({
    item_id: productId,
    item_name: productName,
    price: price / 100,  // cents to EUR (Pitfall 1)
    quantity: 1,
    item_category: 'rolgordijnen',
  });
}, [price, productId, productName]);
```

The ref ensures view_item fires only ONCE per product page visit even when the user changes dimensions and the price updates multiple times. Price must be divided by 100 (cents to EUR decimal) per Pitfall 1.

**add_to_cart event (ECOM-02):**

In the existing `handleAddToCart()` function, add the `trackAddToCart` call AFTER the `addItem()` call and BEFORE `setAddedToCart(true)`:

```typescript
trackAddToCart({
  item_id: productId,
  item_name: productName,
  price: price / 100,  // cents to EUR
  quantity: 1,
  item_category: 'rolgordijnen',
  width_cm: parseInt(width, 10),   // custom param per locked decision
  height_cm: parseInt(height, 10), // custom param per locked decision
});
```

Per locked decision: width_cm and height_cm are included as custom event parameters for popular size analysis.

Also add `useRef` to the existing React import (it already imports `useState` and `useEffect`).
  </action>
  <verify>Run `npx tsc --noEmit` — no type errors. Run `npm run build` — build succeeds. Verify in the code that view_item fires once per page visit (ref guard), add_to_cart includes width_cm and height_cm, and prices are divided by 100.</verify>
  <done>DimensionConfigurator fires view_item once on first price load (guarded by useRef) and add_to_cart on every cart addition, both with EUR decimal prices and correct GA4 item parameters. width_cm and height_cm included per locked decision.</done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` passes with no errors
2. `npm run build` completes successfully
3. src/lib/analytics/index.ts exports: trackPageView, trackViewItem, trackAddToCart, trackBeginCheckout, trackPurchase, GA4EcommerceItem, GA_MEASUREMENT_ID
4. DimensionConfigurator imports trackViewItem and trackAddToCart from @/lib/analytics
5. view_item uses useRef guard — fires once per product page visit
6. add_to_cart includes width_cm and height_cm custom params
7. All prices passed to GA4 functions are in EUR (divided by 100 from cents)
</verification>

<success_criteria>
- Analytics module has 4 new e-commerce event functions following GA4 recommended schema
- DimensionConfigurator fires view_item on first price load and add_to_cart on cart addition
- No TypeScript errors, build passes
- Prices are in EUR decimal (not cents)
- width_cm and height_cm custom params present in add_to_cart per locked decision
</success_criteria>

<output>
After completion, create `.planning/phases/24-e-commerce-events/24-01-SUMMARY.md`
</output>
