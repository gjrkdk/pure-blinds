---
phase: 05-shopify-integration---checkout
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/env.ts
  - .env.local
  - src/lib/shopify/types.ts
  - src/lib/shopify/draft-order.ts
  - src/app/api/checkout/route.ts
autonomous: true

must_haves:
  truths:
    - "POST /api/checkout accepts cart items and returns invoiceUrl from Shopify"
    - "SHOPIFY_PRODUCT_ID validated at startup (fail-fast)"
    - "Draft Order line items use custom line items with locked pricing (no variantId)"
    - "Each line item title includes dimensions (e.g. 'Venetian Blinds 25mm - 100cm x 150cm')"
    - "Each line item has width and height custom attributes"
    - "userErrors from Shopify mutation are checked and cause 500 response"
  artifacts:
    - path: "src/lib/env.ts"
      provides: "SHOPIFY_PRODUCT_ID in env schema"
      contains: "SHOPIFY_PRODUCT_ID"
    - path: "src/lib/shopify/draft-order.ts"
      provides: "createDraftOrder pure function"
      exports: ["createDraftOrder"]
    - path: "src/lib/shopify/types.ts"
      provides: "TypeScript types for checkout request and draft order"
    - path: "src/app/api/checkout/route.ts"
      provides: "POST endpoint for checkout"
      exports: ["POST"]
  key_links:
    - from: "src/app/api/checkout/route.ts"
      to: "src/lib/shopify/draft-order.ts"
      via: "import createDraftOrder"
      pattern: "import.*createDraftOrder.*from.*draft-order"
    - from: "src/lib/shopify/draft-order.ts"
      to: "src/lib/shopify/client.ts"
      via: "import createAdminClient"
      pattern: "import.*createAdminClient.*from.*client"
    - from: "src/lib/shopify/draft-order.ts"
      to: "Shopify GraphQL API"
      via: "draftOrderCreate mutation"
      pattern: "draftOrderCreate"
---

<objective>
Build the backend checkout pipeline: env validation for SHOPIFY_PRODUCT_ID, Draft Order creation function using Shopify GraphQL API, and POST /api/checkout route handler.

Purpose: Backend infrastructure that converts cart items into a Shopify Draft Order with custom pricing and returns the checkout URL.
Output: Working API endpoint that accepts cart items and returns a Shopify invoiceUrl.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shopify-integration---checkout/05-CONTEXT.md
@.planning/phases/05-shopify-integration---checkout/05-RESEARCH.md

Key source files:
@src/lib/env.ts
@src/lib/shopify/client.ts
@src/lib/cart/types.ts
@src/app/api/pricing/route.ts
@.env.local
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add SHOPIFY_PRODUCT_ID to env schema and .env.local</name>
  <files>src/lib/env.ts, .env.local</files>
  <action>
1. In `src/lib/env.ts`, add `SHOPIFY_PRODUCT_ID` to the envSchema:
   ```typescript
   SHOPIFY_PRODUCT_ID: z.string().min(1, "SHOPIFY_PRODUCT_ID is required"),
   ```
   Place it after the existing SHOPIFY_API_VERSION field.

2. In `.env.local`, add a placeholder value:
   ```
   SHOPIFY_PRODUCT_ID=your-shopify-product-id
   ```
   Append after the existing SHOPIFY_API_VERSION line.

This follows the fail-fast env validation pattern from Phase 1 (01-01). The app will throw a clear error on startup if the product ID is missing.
  </action>
  <verify>Run `npx next build` or start the dev server - it should fail with "SHOPIFY_PRODUCT_ID is required" if the placeholder is left as-is, OR succeed if a valid product ID is set. Verify the env.ts file includes the new field by reading it.</verify>
  <done>SHOPIFY_PRODUCT_ID is in the Zod schema and .env.local has a placeholder entry.</done>
</task>

<task type="auto">
  <name>Task 2: Create Draft Order function, types, and checkout API route</name>
  <files>src/lib/shopify/types.ts, src/lib/shopify/draft-order.ts, src/app/api/checkout/route.ts</files>
  <action>
**Step 1: Create `src/lib/shopify/types.ts`**

Define TypeScript types for the checkout flow:

```typescript
import { CartItem } from '@/lib/cart/types';

/** Request body for POST /api/checkout */
export interface CheckoutRequest {
  items: CartItem[];
}

/** Successful response from POST /api/checkout */
export interface CheckoutResponse {
  invoiceUrl: string;
}

/** Error response from POST /api/checkout */
export interface CheckoutErrorResponse {
  error: string;
}
```

**Step 2: Create `src/lib/shopify/draft-order.ts`**

Pure function that creates a Shopify Draft Order from cart items. This is the core business logic, separated from the route handler (thin handler pattern from 02-02).

Key implementation details:
- Import `createAdminClient` from `@/lib/shopify/client`
- Import `env` from `@/lib/env` for SHOPIFY_PRODUCT_ID (used in product name prefix, but NOT as variantId)
- Define the `DRAFT_ORDER_CREATE` GraphQL mutation string (see RESEARCH.md code examples)
- Map CartItem[] to line items using CUSTOM line items (title + originalUnitPriceWithCurrency), NOT variantId (known API bug - see RESEARCH.md Pitfall 1)
- Line item title format: `"${item.productName} - ${item.options.width}cm x ${item.options.height}cm"`
- Price: `{ amount: (item.priceInCents / 100).toFixed(2), currencyCode: "EUR" }` (use EUR - this is a European textile shop)
- Custom attributes: separate `width` and `height` keys with string values
- Check `response.data?.draftOrderCreate?.userErrors` array - if non-empty, throw an error
- Check that `invoiceUrl` exists in response - if missing, throw an error
- Catch `GraphqlQueryError` from `@shopify/shopify-api` separately for network/auth errors
- Return `{ invoiceUrl }` on success
- Use `retries: 2` in the client.request() call for resilience

GraphQL mutation:
```graphql
mutation draftOrderCreate($input: DraftOrderInput!) {
  draftOrderCreate(input: $input) {
    draftOrder {
      id
      invoiceUrl
    }
    userErrors {
      field
      message
    }
  }
}
```

Function signature: `export async function createDraftOrder(items: CartItem[]): Promise<{ invoiceUrl: string }>`

Validate that items array is non-empty (throw if empty).

**Step 3: Create `src/app/api/checkout/route.ts`**

Thin API handler following the exact same pattern as `src/app/api/pricing/route.ts`:

```typescript
import { NextResponse } from "next/server";
import { createDraftOrder } from "@/lib/shopify/draft-order";

export async function POST(request: Request) {
  try {
    const body = await request.json();

    // Validate items exist and is non-empty array
    if (!body.items || !Array.isArray(body.items) || body.items.length === 0) {
      return NextResponse.json(
        { error: "Cart is empty" },
        { status: 400 }
      );
    }

    const result = await createDraftOrder(body.items);

    return NextResponse.json(result, { status: 200 });
  } catch (error) {
    // User-friendly error only (CONTEXT.md decision)
    return NextResponse.json(
      { error: "Unable to process checkout. Please try again." },
      { status: 500 }
    );
  }
}
```

No Zod validation on the request body - the cart items come from our own client-side store and the draft order function handles the mapping. Keep it simple for MVP.
  </action>
  <verify>
1. Read all three created files to verify structure
2. Run `npx tsc --noEmit` to verify TypeScript compiles without errors
3. Run `curl -X POST http://localhost:3000/api/checkout -H "Content-Type: application/json" -d '{"items":[]}' ` should return 400 with "Cart is empty"
4. If dev server is running with valid Shopify credentials and a real SHOPIFY_PRODUCT_ID, test with a sample cart item to verify Draft Order creation (optional - depends on credentials being configured)
  </verify>
  <done>
- src/lib/shopify/types.ts exports CheckoutRequest, CheckoutResponse, CheckoutErrorResponse
- src/lib/shopify/draft-order.ts exports createDraftOrder that calls Shopify GraphQL API
- src/app/api/checkout/route.ts exports POST handler that delegates to createDraftOrder
- TypeScript compiles without errors
- Empty cart returns 400
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` passes (no type errors)
- POST /api/checkout with empty items returns 400
- POST /api/checkout with valid items returns 200 with invoiceUrl (requires valid Shopify credentials)
- Draft Order appears in Shopify admin (requires valid credentials)
- Line items in Draft Order show custom pricing and dimension attributes
</verification>

<success_criteria>
- SHOPIFY_PRODUCT_ID validated at startup via Zod env schema
- createDraftOrder function creates Shopify Draft Orders with custom line items
- Line items include dimensions in title and as custom attributes
- Prices locked via originalUnitPriceWithCurrency (not variant pricing)
- userErrors checked in mutation response
- POST /api/checkout route follows thin handler pattern
- TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-shopify-integration---checkout/05-01-SUMMARY.md`
</output>
