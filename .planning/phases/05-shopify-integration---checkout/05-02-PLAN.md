---
phase: 05-shopify-integration---checkout
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/components/cart/cart-summary.tsx
autonomous: false

must_haves:
  truths:
    - "Clicking checkout button calls POST /api/checkout with cart items"
    - "Button shows loading spinner and 'Preparing checkout...' during API call"
    - "Button is disabled during loading to prevent double-submission"
    - "On success, browser redirects to Shopify invoiceUrl in same window"
    - "On error, user sees friendly error message and button re-enables"
    - "Cart items persist after redirect (not cleared)"
    - "Checkout flow works on mobile (touch targets, responsive layout)"
  artifacts:
    - path: "src/components/cart/cart-summary.tsx"
      provides: "Checkout button with loading state, API call, redirect"
      contains: "api/checkout"
  key_links:
    - from: "src/components/cart/cart-summary.tsx"
      to: "/api/checkout"
      via: "fetch POST request"
      pattern: "fetch.*api/checkout"
    - from: "src/components/cart/cart-summary.tsx"
      to: "window.location"
      via: "same-window redirect to invoiceUrl"
      pattern: "window\\.location"
    - from: "src/components/cart/cart-summary.tsx"
      to: "src/lib/cart/store.ts"
      via: "useCartStore for items"
      pattern: "useCartStore"
---

<objective>
Wire the checkout button in cart-summary.tsx to call the checkout API, show loading state, handle errors, and redirect to Shopify checkout on success.

Purpose: Complete the user-facing checkout flow from cart to Shopify payment.
Output: Functional checkout button that creates a Draft Order and redirects to Shopify checkout.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-shopify-integration---checkout/05-CONTEXT.md
@.planning/phases/05-shopify-integration---checkout/05-RESEARCH.md
@.planning/phases/05-shopify-integration---checkout/05-01-SUMMARY.md

Key source files:
@src/components/cart/cart-summary.tsx
@src/lib/cart/store.ts
@src/lib/cart/types.ts
@src/components/dimension-configurator.tsx (loading state pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire checkout button with loading state, API call, and redirect</name>
  <files>src/components/cart/cart-summary.tsx</files>
  <action>
Update `src/components/cart/cart-summary.tsx` to replace the placeholder `handleCheckout` with a real implementation.

Changes to make:

1. **Add state variables** at the top of the component (after existing useState/useEffect):
   ```typescript
   const [loading, setLoading] = useState(false);
   const [error, setError] = useState<string | null>(null);
   ```

2. **Get items from cart store** (add alongside existing selectors):
   ```typescript
   const items = useCartStore((state) => state.items);
   ```

3. **Replace handleCheckout** with async function:
   ```typescript
   const handleCheckout = async () => {
     setLoading(true);
     setError(null);

     try {
       const response = await fetch('/api/checkout', {
         method: 'POST',
         headers: { 'Content-Type': 'application/json' },
         body: JSON.stringify({ items }),
       });

       const data = await response.json();

       if (response.ok && data.invoiceUrl) {
         // Redirect to Shopify checkout in same window
         // Loading state intentionally persists until page unloads
         window.location.href = data.invoiceUrl;
       } else {
         setError(data.error || 'Unable to process checkout. Please try again.');
         setLoading(false);
       }
     } catch {
       setError('Unable to process checkout. Please try again.');
       setLoading(false);
     }
   };
   ```

4. **Update button** to show loading state:
   - Add `loading` to disabled condition: `disabled={loading || itemCount === 0}`
   - Replace button text with conditional:
     - When loading: Show spinner + "Preparing checkout..." (see spinner pattern below)
     - When not loading: Show "Proceed to Checkout"
   - Spinner: `<span className="inline-block h-4 w-4 animate-spin rounded-full border-2 border-white border-t-transparent"></span>` inside a flex container with the text

5. **Add error message** below the button:
   ```tsx
   {error && (
     <p className="mt-2 text-center text-sm text-red-600">{error}</p>
   )}
   ```

Important implementation notes:
- Do NOT clear the cart after redirect (CONTEXT.md decision - Phase 6 handles this)
- Do NOT reset loading state on successful redirect (loading persists until page navigates away)
- Keep the existing mounted check pattern for hydration safety
- Keep the existing formatPrice function
- Keep the existing sticky footer layout (fixed bottom, z-10, border-t, shadow-lg)
- The button already has min-h-[44px] for mobile touch targets - keep this
  </action>
  <verify>
1. Run `npx tsc --noEmit` to verify TypeScript compiles
2. Start dev server and navigate to cart page with items
3. Verify button shows "Proceed to Checkout" when idle
4. Click checkout - verify loading spinner appears with "Preparing checkout..."
5. Verify button is disabled during loading
6. If Shopify credentials are valid: verify redirect to Shopify checkout URL
7. If credentials invalid: verify error message appears and button re-enables
  </verify>
  <done>
- Checkout button calls POST /api/checkout with cart items
- Loading spinner with "Preparing checkout..." shown during API call
- Button disabled during loading
- Same-window redirect to invoiceUrl on success
- Error message displayed on failure, button re-enables
- Cart items not cleared after redirect
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>Complete checkout flow: cart items are sent to POST /api/checkout, which creates a Shopify Draft Order with custom pricing and dimension metadata, returns the invoiceUrl, and the browser redirects to Shopify's native checkout page.</what-built>
  <how-to-verify>
1. Start the dev server: `npm run dev`
2. Navigate to the product page, configure dimensions (e.g., width: 100, height: 150)
3. Add the item to cart
4. Go to the cart page
5. Click "Proceed to Checkout"
6. Verify: Loading spinner appears with "Preparing checkout..."
7. Verify: You are redirected to a Shopify checkout page
8. Verify: The checkout shows the correct product name with dimensions (e.g., "Venetian Blinds 25mm - 100cm x 150cm")
9. Verify: The price matches what was shown in the cart
10. (Optional) Check Shopify admin for the created Draft Order - verify custom attributes show width and height

To test error handling:
- Temporarily set an invalid SHOPIFY_ADMIN_ACCESS_TOKEN in .env.local
- Try checkout - verify error message "Unable to process checkout. Please try again." appears
- Verify button re-enables after error
  </how-to-verify>
  <resume-signal>Type "approved" or describe any issues with the checkout flow</resume-signal>
</task>

</tasks>

<verification>
- Checkout button shows loading state during API call
- Successful checkout redirects to Shopify checkout URL
- Failed checkout shows user-friendly error message
- Cart items persist after redirect (verify by going back)
- Button disabled during loading prevents double-submission
- Mobile: button has adequate touch target (min-h-[44px])
</verification>

<success_criteria>
- Complete checkout flow works: cart -> API -> Draft Order -> Shopify checkout
- Loading state provides clear feedback ("Preparing checkout...")
- Error handling is user-friendly (no technical details shown)
- Cart persists after redirect
- Works on mobile devices (responsive layout, touch targets)
</success_criteria>

<output>
After completion, create `.planning/phases/05-shopify-integration---checkout/05-02-SUMMARY.md`
</output>
