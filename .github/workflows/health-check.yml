name: Post-Deployment Health Check

on:
  deployment_status:

jobs:
  health-check:
    name: Verify deployment
    runs-on: ubuntu-latest
    if: >
      github.event.deployment_status.state == 'success' &&
      github.event.deployment_status.environment == 'Production'

    steps:
      - name: Get deployment URL
        id: url
        run: echo "target=${{ github.event.deployment_status.target_url }}" >> "$GITHUB_OUTPUT"

      - name: Wait for deployment to stabilize
        run: sleep 10

      - name: Check /api/health
        run: |
          for i in 1 2 3; do
            status=$(curl -s -o /dev/null -w '%{http_code}' \
              --max-time 15 \
              "${{ steps.url.outputs.target }}/api/health")
            if [ "$status" = "200" ]; then
              echo "Health check passed (HTTP $status)"
              exit 0
            fi
            echo "Attempt $i: HTTP $status, retrying in 10s..."
            sleep 10
          done
          echo "::error::Health check failed after 3 attempts (last HTTP $status)"
          exit 1

      - name: Smoke test /api/pricing
        run: |
          for i in 1 2 3; do
            status=$(curl -s -o /dev/null -w '%{http_code}' \
              --max-time 15 \
              -X POST \
              -H "Content-Type: application/json" \
              -d '{}' \
              "${{ steps.url.outputs.target }}/api/pricing")
            if [ "$status" -ge 200 ] && [ "$status" -lt 500 ]; then
              echo "Pricing endpoint is live (HTTP $status)"
              exit 0
            fi
            echo "Attempt $i: HTTP $status, retrying in 10s..."
            sleep 10
          done
          echo "::error::Pricing endpoint unreachable after 3 attempts (last HTTP $status)"
          exit 1

      - name: Smoke test /api/checkout
        run: |
          for i in 1 2 3; do
            status=$(curl -s -o /dev/null -w '%{http_code}' \
              --max-time 15 \
              -X POST \
              -H "Content-Type: application/json" \
              -d '{}' \
              "${{ steps.url.outputs.target }}/api/checkout")
            if [ "$status" -ge 200 ] && [ "$status" -lt 500 ]; then
              echo "Checkout endpoint is live (HTTP $status)"
              exit 0
            fi
            echo "Attempt $i: HTTP $status, retrying in 10s..."
            sleep 10
          done
          echo "::error::Checkout endpoint unreachable after 3 attempts (last HTTP $status)"
          exit 1

      - name: Report failure
        if: failure()
        run: |
          echo "::error::Post-deployment health check failed for ${{ steps.url.outputs.target }}"
          echo ""
          echo "One or more endpoints did not respond correctly after deployment."
          echo "Deployment URL: ${{ steps.url.outputs.target }}"
          echo ""
          echo "Failed checks should be visible in the step logs above."
          exit 1
