{% capture email_title %}
  {% if payment_terms %}
    Controleer en bevestig om je bestelling af te ronden
  {% else %}
    Rond je aankoop af
  {% endif %}
{% endcapture %}

{% capture email_body %}
  {% if item_count > 1 %}
    Deze artikelen worden voor je gereserveerd tot {{ reserve_inventory_until | date: format: 'date_at_time' }}.
  {% else %}
    Dit artikel wordt voor je gereserveerd tot {{ reserve_inventory_until | date: format: 'date_at_time' }}.
  {% endif %}
{% endcapture %}

<!DOCTYPE html>
<html lang="nl">
  <head>
    <title>{{ email_title }}</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width">
    <link rel="stylesheet" type="text/css" href="/assets/notifications/styles.css">
    <style>
      .button__cell { background: {{ shop.email_accent_color }}; }
      a, a:hover, a:active, a:visited { color: {{ shop.email_accent_color }}; }
    </style>
  </head>

  <body>
    <table class="body">
      <tr>
        <td>
          <!-- ====== HEADER ====== -->
          <table class="header row">
            <tr>
              <td class="header__cell">
                <center>
                  <table class="container">
                    <tr>
                      <td>
                        <table class="row">
                          <tr>
                            <td class="shop-name__cell">
                              {%- if shop.email_logo_url %}
                                <img src="{{shop.email_logo_url}}" alt="{{ shop.name }}" width="{{ shop.email_logo_width }}">
                              {%- else %}
                                <h1 class="shop-name__text">
                                  <a href="{{shop.url}}">{{ shop.name }}</a>
                                </h1>
                              {%- endif %}
                            </td>
                            <td>
                              <table class="order-po-number__container">
                                <tr>
                                  <td class="order-number__cell">
                                    <span class="order-number__text">
                                      Factuur {{ name }}
                                    </span>
                                  </td>
                                </tr>
                                {%- if po_number %}
                                  <tr>
                                    <td class="po-number__cell">
                                      <span class="po-number__text">
                                        PO-nummer #{{ po_number }}
                                      </span>
                                    </td>
                                  </tr>
                                {%- endif %}
                              </table>
                            </td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                </center>
              </td>
            </tr>
          </table>

          <!-- ====== EMAIL TITLE + BODY + CTA ====== -->
          <table class="row content">
            <tr>
              <td class="content__cell">
                <center>
                  <table class="container">
                    <tr>
                      <td>
                        <h2>{{ email_title }}</h2>
                        {% if custom_message != blank %}
                          <p>{{ custom_message }}</p>
                        {% elsif reserve_inventory_until %}
                          <p>{{ email_body }}</p>
                        {% endif %}

                        {% if payment_terms %}
                          <table class="row actions">
                            <tr>
                              <td class="empty-line">&nbsp;</td>
                            </tr>
                            <tr>
                              <td class="actions__cell">
                                <table class="button main-action-cell">
                                  <tr>
                                    <td class="button__cell"><a href="{{ invoice_url }}" class="button__text">Bestelling bevestigen</a></td>
                                  </tr>
                                </table>
                                {% if shop.url %}
                                  <table class="link secondary-action-cell">
                                    <tr>
                                      <td class="link__cell">of <a href="{{ shop.url }}">Bezoek onze webshop</a></td>
                                    </tr>
                                  </table>
                                {% endif %}
                              </td>
                            </tr>
                          </table>
                        {% else %}
                          <table class="row actions">
                            <tr>
                              <td class="empty-line">&nbsp;</td>
                            </tr>
                            <tr>
                              <td class="actions__cell">
                                <table class="button main-action-cell">
                                  <tr>
                                    <td class="button__cell"><a href="{{ invoice_url }}" class="button__text">Aankoop afronden</a></td>
                                  </tr>
                                </table>
                                {% if shop.url %}
                                  <table class="link secondary-action-cell">
                                    <tr>
                                      <td class="link__cell">of <a href="{{ shop.url }}">Bezoek onze webshop</a></td>
                                    </tr>
                                  </table>
                                {% endif %}
                              </td>
                            </tr>
                          </table>
                        {% endif %}
                      </td>
                    </tr>
                  </table>
                </center>
              </td>
            </tr>
          </table>

          <!-- ====== ORDER SUMMARY ====== -->
          <table class="row section">
            <tr>
              <td class="section__cell">
                <center>
                  <table class="container">
                    <tr>
                      <td>
                        <h3>Besteloverzicht</h3>
                      </td>
                    </tr>
                  </table>
                  <table class="container">
                    <tr>
                      <td>
                        <table class="row">
                          {% for line in subtotal_line_items %}
                            <tr class="order-list__item">
                              <td class="order-list__item__cell">
                                <table>
                                  <td class="order-list__image-cell">
                                    {% if line.image %}
                                      <img src="{{ line | img_url: 'compact_cropped' }}" align="left" width="60" height="60" class="order-list__product-image"/>
                                    {% else %}
                                      <div class="order-list__no-image-cell">
                                        <img src="{{ 'notifications/no-image.png' | shopify_asset_url }}" align="left" width="60" height="60" class="order-list__no-product-image"/>
                                      </div>
                                    {% endif %}
                                  </td>

                                  <td class="order-list__product-description-cell">
                                    {% if line.presentment_title %}
                                      {% assign line_title = line.presentment_title %}
                                    {% elsif line.title %}
                                      {% assign line_title = line.title %}
                                    {% else %}
                                      {% assign line_title = line.product.title %}
                                    {% endif %}
                                    {% assign line_display = line.quantity %}

                                    <span class="order-list__item-title">{{ line_title }}&nbsp;&times;&nbsp;{{ line_display }}</span><br/>

                                    {% if line.variant.title != 'Default Title' %}
                                      <span class="order-list__item-variant">{{ line.variant.title }}</span><br/>
                                    {% endif %}

                                    <!-- Custom attributes (Breedte, Hoogte, etc.) -->
                                    {% for property in line.properties %}
                                      {% assign property_first_char = property.first | slice: 0 %}
                                      {% if property.last != blank and property_first_char != '_' and property.first != 'Product ID' %}
                                        <span class="order-list__item-variant">
                                          {% case property.first %}
                                            {% when 'Width' %}Breedte
                                            {% when 'Height' %}Hoogte
                                            {% when 'Type' %}Type
                                            {% else %}{{ property.first }}
                                          {% endcase %}: {{ property.last }}
                                        </span><br/>
                                      {% endif %}
                                    {% endfor %}

                                    {% if line.selling_plan_allocation %}
                                      <span class="order-list__item-variant">{{ line.selling_plan_allocation.selling_plan.name }}</span><br/>
                                    {% endif %}

                                    {% if line.discount_allocations %}
                                      {% for discount_allocation in line.discount_allocations %}
                                        {% if discount_allocation.discount_application.target_selection != 'all' %}
                                          <p>
                                            <span class="order-list__item-discount-allocation">
                                              <img src="{{ 'notifications/discounttag.png' | shopify_asset_url }}" width="18" height="18" class="discount-tag-icon" />
                                              <span>
                                                {{ discount_allocation.discount_application.title | upcase }}
                                                (-{{ discount_allocation.amount | money }})
                                              </span>
                                            </span>
                                          </p>
                                        {% endif %}
                                      {% endfor %}
                                    {% endif %}
                                  </td>

                                  <td class="order-list__price-cell">
                                    {% if line.original_line_price != line.final_line_price %}
                                      <del class="order-list__item-original-price">{{ line.original_line_price | money }}</del>
                                    {% endif %}
                                    <p class="order-list__item-price">
                                      {% if line.final_line_price > 0 %}
                                        {{ line.final_line_price | money }}
                                      {% else %}
                                        Gratis
                                      {% endif %}
                                    </p>
                                  </td>
                                </table>
                              </td>
                            </tr>
                          {% endfor %}
                        </table>

                        <!-- ====== SUBTOTALS ====== -->
                        <table class="row subtotal-lines">
                          <tr>
                            <td class="subtotal-spacer"></td>
                            <td>
                              <table class="row subtotal-table">
                                {% assign order_discount_count = 0 %}
                                {% assign total_order_discount_amount = 0 %}
                                {% assign subtotal_order_amount = 0 %}
                                {% assign has_shipping_discount = false %}

                                {% for discount_application in discount_applications %}
                                  {% if discount_application.target_selection == 'all' and discount_application.target_type == 'line_item' %}
                                    {% assign order_discount_count = order_discount_count | plus: 1 %}
                                    {% assign total_order_discount_amount = total_order_discount_amount | plus: discount_application.total_allocated_amount %}
                                    {% assign subtotal_order_amount = subtotal_order_amount | plus: discount_application.total_allocated_amount %}
                                  {% endif %}
                                  {% if discount_application.target_type == 'shipping_line' %}
                                    {% assign has_shipping_discount = true %}
                                    {% assign shipping_discount = discount_application.title %}
                                    {% assign shipping_amount = discount_application.total_allocated_amount %}
                                    {% assign subtotal_order_amount = subtotal_order_amount | plus: discount_application.total_allocated_amount %}
                                    {% assign discounted_shipping_price = shipping_price | minus: shipping_amount %}
                                  {% endif %}
                                {% endfor %}

                                <tr class="subtotal-line">
                                  <td class="subtotal-line__title">
                                    <p><span>Subtotaal</span></p>
                                  </td>
                                  <td class="subtotal-line__value">
                                    <strong>{{ subtotal_price | plus: subtotal_order_amount | money }}</strong>
                                  </td>
                                </tr>

                                {% if order_discount_count > 0 %}
                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p><span>{% if order_discount_count == 1 %}Bestelkorting{% else %}Bestelkortingen{% endif %}</span></p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>-{{ total_order_discount_amount | money }}</strong>
                                    </td>
                                  </tr>
                                  {% for discount_application in discount_applications %}
                                    {% if discount_application.target_selection == 'all' and discount_application.target_type != 'shipping_line' %}
                                      <tr class="subtotal-line">
                                        <td class="subtotal-line__title">
                                          <p>
                                            <span class="subtotal-line__discount">
                                              <img src="{{ 'notifications/discounttag.png' | shopify_asset_url }}" width="18" height="18" class="discount-tag-icon" />
                                              <span class="subtotal-line__discount-title">
                                                {{ discount_application.title }} (-{{ discount_application.total_allocated_amount | money }})
                                              </span>
                                            </span>
                                          </p>
                                        </td>
                                      </tr>
                                    {% endif %}
                                  {% endfor %}
                                {% endif %}

                                {% if delivery_method == 'pick-up' %}
                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p><span>Afhalen</span></p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ shipping_price | money }}</strong>
                                    </td>
                                  </tr>
                                {% else %}
                                  {% if has_shipping_discount %}
                                    {% if discounted_shipping_price > 0 %}
                                      <tr class="subtotal-line">
                                        <td class="subtotal-line__title">
                                          <p><span>Verzending</span></p>
                                        </td>
                                        <td class="subtotal-line__value">
                                          <strong>{{ discounted_shipping_price | money }}</strong>
                                        </td>
                                      </tr>
                                    {% else %}
                                      <tr class="subtotal-line">
                                        <td class="subtotal-line__title">
                                          <p><span>Verzending</span></p>
                                        </td>
                                        <td class="subtotal-line__value">
                                          <strong>Gratis</strong>
                                        </td>
                                      </tr>
                                    {% endif %}
                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p>
                                          <span class="subtotal-line__discount">
                                            <img src="{{ 'notifications/discounttag.png' | shopify_asset_url }}" width="18" height="18" class="discount-tag-icon" />
                                            <span class="subtotal-line__discount-title">
                                              {{ shipping_discount }} (-{{ shipping_amount | money }})
                                            </span>
                                          </span>
                                        </p>
                                      </td>
                                    </tr>
                                  {% else %}
                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p><span>Verzending</span></p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>{{ shipping_price | money }}</strong>
                                      </td>
                                    </tr>
                                  {% endif %}
                                {% endif %}

                                {% if total_duties %}
                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p><span>Invoerrechten</span></p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ total_duties | money }}</strong>
                                    </td>
                                  </tr>
                                {% endif %}

                                <tr class="subtotal-line">
                                  <td class="subtotal-line__title">
                                    <p><span>Geschatte BTW</span></p>
                                  </td>
                                  <td class="subtotal-line__value">
                                    <strong>{{ tax_price | money }}</strong>
                                  </td>
                                </tr>

                                {% if total_tip and total_tip > 0 %}
                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p><span>Fooi</span></p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ total_tip | money }}</strong>
                                    </td>
                                  </tr>
                                {% endif %}
                              </table>

                              <table class="row subtotal-table subtotal-table--total">
                                {% if payment_terms %}
                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p><span>Vandaag te betalen</span></p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ amount_due_now | money_with_currency }}</strong>
                                    </td>
                                  </tr>

                                  {% assign next_payment = payment_terms.next_payment %}
                                  {% assign due_at_date = next_payment.due_at | date: format: 'date' %}
                                  {% assign next_amount_due = total_price | minus: amount_due_now %}

                                  {% if payment_terms.type == 'receipt' %}
                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p><span>Te betalen bij ontvangst</span></p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>{{ next_amount_due | money_with_currency }}</strong>
                                      </td>
                                    </tr>
                                  {% elsif payment_terms.type == 'fulfillment' %}
                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p><span>Te betalen bij levering</span></p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>{{ next_amount_due | money_with_currency }}</strong>
                                      </td>
                                    </tr>
                                  {% else %}
                                    <tr class="subtotal-line">
                                      <td class="subtotal-line__title">
                                        <p><span>Te betalen op {{ due_at_date }}</span></p>
                                      </td>
                                      <td class="subtotal-line__value">
                                        <strong>{{ next_amount_due | money_with_currency }}</strong>
                                      </td>
                                    </tr>
                                  {% endif %}
                                {% else %}
                                  <tr class="subtotal-line">
                                    <td class="subtotal-line__title">
                                      <p><span>Totaal</span></p>
                                    </td>
                                    <td class="subtotal-line__value">
                                      <strong>{{ total_price | money_with_currency }}</strong>
                                    </td>
                                  </tr>
                                {% endif %}
                              </table>

                              {% if total_discounts > 0 %}
                                <p class="total-discount">
                                  Je bespaarde <span class="total-discount--amount">{{ total_discounts | money }}</span>
                                </p>
                              {% endif %}
                            </td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                </center>
              </td>
            </tr>
          </table>

          <!-- ====== CUSTOMER INFORMATION ====== -->
          {% if shipping_address or billing_address or shipping_method or company_location or payment_terms %}
            <table class="row section">
              <tr>
                <td class="section__cell">
                  <center>
                    <table class="container">
                      <tr>
                        <td>
                          <h3>Klantgegevens</h3>
                        </td>
                      </tr>
                    </table>
                    <table class="container">
                      <tr>
                        <td>
                          <table class="row">
                            <tr>
                              {% if shipping_address %}
                                <td class="customer-info__item">
                                  <h4>Verzendadres</h4>
                                  {{ shipping_address | format_address }}
                                </td>
                              {% endif %}
                              {% if billing_address %}
                                <td class="customer-info__item">
                                  <h4>Factuuradres</h4>
                                  {{ billing_address | format_address }}
                                </td>
                              {% endif %}
                            </tr>
                          </table>
                          {% if shipping_method or company_location or payment_terms %}
                            <table class="row">
                              <tr>
                                {% if company_location %}
                                  <td class="customer-info__item">
                                    <h4>Locatie</h4>
                                    <p>{{ company_location.name }}</p>
                                  </td>
                                {% endif %}
                                {% if payment_terms %}
                                  <td class="customer-info__item">
                                    <h4>Betaling</h4>
                                    {% assign due_date = payment_terms.next_payment.due_at | default: nil %}
                                    {% if payment_terms.type == 'receipt' or payment_terms.type == 'fulfillment' %}
                                      <p>{{ payment_terms.translated_name }}</p>
                                    {% else %}
                                      <p>{{ payment_terms.translated_name }}: vervalt {{ due_date | date: format: 'date' }}</p>
                                    {% endif %}
                                  </td>
                                {% endif %}
                              </tr>
                              <tr>
                                {% if shipping_method %}
                                  <td class="customer-info__item customer-info__item--last">
                                    <h4>Verzendmethode</h4>
                                    {% if local_pickup %}
                                      <p>Lokaal afhalen - {{ shipping_method.title }}</p>
                                      {% if local_pickup_address %}
                                        {{ local_pickup_address | format_address }}
                                      {% endif %}
                                    {% else %}
                                      <p>{{ shipping_method.title }}<br/>{{ shipping_method.price | money }}</p>
                                    {% endif %}
                                  </td>
                                  <td class="customer-info__item customer-info__item--last">
                                  </td>
                                {% endif %}
                              </tr>
                            </table>
                          {% endif %}
                        </td>
                      </tr>
                    </table>
                  </center>
                </td>
              </tr>
            </table>
          {% endif %}

          <!-- ====== FOOTER ====== -->
          <table class="row footer">
            <tr>
              <td class="footer__cell">
                <center>
                  <table class="container">
                    <tr>
                      <td>
                        <p class="disclaimer__subtext">Heb je vragen? Antwoord op deze e-mail of neem contact op via <a href="mailto:{{ shop.email }}">{{ shop.email }}</a></p>
                      </td>
                    </tr>
                  </table>
                </center>
              </td>
            </tr>
          </table>

          <img src="{{ 'notifications/spacer.png' | shopify_asset_url }}" class="spacer" height="1" />

        </td>
      </tr>
    </table>
  </body>
</html>
